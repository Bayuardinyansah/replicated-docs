# Embedded Cluster Air Gap (Alpha)

This topic describes how to install applications with Embedded Cluster in air gap environments with no outbound internet access.

## About the Embedded Cluster Air Gap Bundle Format

An Embedded Cluster air gap bundle contains the necessary artifacts to install the infrastructure (Embedded Cluster/k0s and Helm extensions) and the vendor’s application.

The Embedded Cluster air gap bundle contains the artifacts normally contained in an application air gap bundle (`airgap.yaml`, `app.tar.gz`, and an images directory), but it also contains an `embedded-cluster` directory with the artifacts needed for the infrastructure.

When an air gap bundle is built for a release containing an Embedded Cluster config, both an application air gap bundle and an Embedded Cluster air gap bundle are built, so you can do an air gap installation with KOTS/kURL or with Embedded Cluster.

## About the Architecture

A Docker registry is deployed to the cluster to store application images. Infrastructure images (for Embedded Cluster and Helm extensions) and the Helm charts are preloaded on each node at installation time.

## Prerequisite

Embedded cluster version 1.3.0 or later

## Install

Create a release with an Embedded Cluster config and promote it to a channel.

If the channel has automatic air gap builds, watch for the build status to complete. If automatic air gap builds are not enabled, go to the channel release history and build the air gap bundle manually (docs). Errors in building either the application air gap bundle or the Embedded Cluster infrastructure will be shown if present.

To install with Embedded Cluster in air gap environments:

1. Go to the customer page for the customer you want to use for the air gap installation. Click **Install instructions > Embedded cluster** to get the Embedded Cluster install instructions. (docs)

1. To download the air gap (instead of online) installation artifacts, modify the curl command by adding the `?airgap=true` query parameter to the end of the replicated.app endpoint.

	**Example:**

    ```bash
    curl https://replicated.app/embedded/APP_SLUG/CHANNEL_SLUG?airgap=true -H "Authorization: LICENSE_ID" -o 	APP_SLUG-CHANNEL_SLUG.tgz
    ```

1. Run that curl command on your air gapped VM. Once the download completes, untar it following the instructions in the vendor portal. This will produce three files: the installer and the license (as usual) and the air gap bundle (`APP_SLUG.airgap`).

1. Install the application with the install command copied from the vendor portal, but add the undocumented `--airgap-bundle` flag to pass the air gap bundle to the installation.

	**Example:**

    ```bash
    sudo ./APP_SLUG install --license license.yaml --airgap-bundle APP_SLUG.airgap
    ```

## Add Nodes to Air Gap Clusters

You can add nodes to an air gap cluster. This involves downloading the Embedded Cluster artifacts to each node, copying a join command from the Admin Console, and running the join command on each node.

### Prerequisites
The Embedded Cluster binary and the air gap bundle must be present on each node you want to join to the cluster. For more information on downloading these artifacts and untarring them, refer to Install.

### Add Nodes
To add nodes to a cluster after successfully installing the first node:

1. Click the link in the install output to access the Admin Console. Proceed through the setup steps until you reach the Nodes page.

1. Click Add node, choose one or more node roles (if present), and copy the join command.

1. SSH onto another machine you want to join to the cluster. Run the join command on this node.

	**Example:**

    ```bash
    sudo ./APP_SLUG join --airgap-bundle APP_SLUG.airgap 10.128.0.32:30000 TxXboDstBAamXaPdleSK7Lid
    ```

1. When you have finished adding all nodes, return to the Admin Console and click Continue.

## Upgrade Air Gap Clusters

To upgrade an installation, new air gap bundles can be uploaded to the Admin Console from the browser or with the Embedded Cluster binary.

Using the binary is faster and allows the user to download the air gap bundle directly to the machine where the Embedded Cluster is running. Using the browser is slower because the user must download the air gap bundle to a machine with a browser, then upload that bundle to the Admin Console, and then the Admin Console can process it. But this is a reasonable method if your air gap bundles are not too large and your customers are more comfortable with a guided approach in the Admin Console.

### Prerequisites

1. Create another release with your changes and promote it to the same channel. This new release can include a new (and later) version of Embedded Cluster and/or changes to your application.

1. If the channel has automatic air gap builds, watch for the build status to complete. If automatic air gap builds are not enabled, go to the channel release history and build the air gap bundle manually (docs). Errors in building either the application air gap bundle or the Embedded Cluster infrastructure will be shown if present.

1. Download the new air gap bundle. This can be done using the same curl command used during installation.

### Upgrade from the Admin Console

On a machine with browser access (e.g., where you accessed the Admin Console to configure the application), download the new air gap bundle using the curl command copied during the install steps. Because this command downloads the latest release on the channel, it will download the bundle for your newly promoted release.

1. Untar the tarball and ensure that the `APP_SLUG.airgap` air gap bundle is present.

1. On that same machine, use a browser to access the Admin Console.

1. From the Admin Console dashboard or **Version history** page, click **Upload new version** and choose the `APP_SLUG.airgap` air gap bundle you just downloaded.

1. When the air gap bundle has been uploaded, click **Deploy** to deploy this new version.

### Upgrade from the Command Line

1. SSH onto a controller node in the cluster and download the new air gap bundle using the curl command copied during the install steps. Because this command downloads the latest release on the channel, it will download the bundle for your newly promoted release.

1. Untar the tarball and ensure that the `APP_SLUG.airgap` air gap bundle is present.

1. Use the update command to upload the air gap bundle and make this new version available in the Admin Console.

	**Example:**

    ```bash
    ./APP_SLUG update --airgap-bundle APP_SLUG.airgap
    ```

1. When the air gap bundle has been uploaded, visit the Admin Console and click **Deploy** to deploy this new version.

## Limitations and Known Issues

* This iteration of air gap installations is not highly available. If the original node is deleted, all registry and KOTS data will be lost. Multi-node HA will be added later for online and air gap installations.
* If you pass ?airgap=true to the replicated.app endpoint but an air gap bundle is not built for the latest release, the API will not return a 404. Instead it will return the tarball without the air gap bundle (i.e., with the installer and the license in it, like for online installations)..
* Images used by Helm extensions must not refer to a multi-architecture image by digest. Only x64 images are included in air gap bundles, and the digest for the x64 image will be different from the digest for the multi-architecture image, preventing the image from being discovered in the bundle. An example of a chart that does this is ingress-nginx/ingress-nginx chart. See the example here for how the digests should be set to empty string to pull by tag only.
* Images for Helm extensions are loaded directly into containerd so that they’re available without internet access. But if an image used by a Helm extension has Always set as the image pull policy, Kubernetes will try to pull the image from the internet. If necessary, use the Helm values to set IfNotPresent as the image pull policy to ensure the extension works in air gap environments.
* On the channel release history page, the links for Download air gap bundle, Copy download URL, and View bundle contents pertain to the application air gap bundle only, not the Embedded Cluster bundle.
