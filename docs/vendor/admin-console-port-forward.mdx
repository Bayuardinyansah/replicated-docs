import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import ServicePortNote from "../partials/custom-resource-application/_servicePort-note.mdx"
import PortsServiceName from "../partials/custom-resource-application/_ports-serviceName.mdx"
import PortsLocalPort from "../partials/custom-resource-application/_ports-localPort.mdx"
import PortsServicePort from "../partials/custom-resource-application/_ports-servicePort.mdx"
import PortsApplicationURL from "../partials/custom-resource-application/_ports-applicationURL.mdx"
import NginxKotsApp from "../partials/application-links/_nginx-kots-app.mdx"
import NginxK8sApp from "../partials/application-links/_nginx-k8s-app.mdx"
import NginxService from "../partials/application-links/_nginx-service.mdx"
import NginxDeployment from "../partials/application-links/_nginx-deployment.mdx"
import GiteaHelmChart from "../partials/getting-started/_gitea-helmchart-cr.mdx"
import GiteaKotsApp from "../partials/getting-started/_gitea-kots-app-cr.mdx"
import GiteaK8sApp from "../partials/getting-started/_gitea-k8s-app-cr.mdx"

# Port Forwarding Services with KOTS

This topic describes how to add one or more ports to the Replicated KOTS port forward tunnel by configuring the `ports` key in the KOTS Application custom resource.

The information in this topic applies to existing cluster installations. For information about exposing services for Replicated kURL or Replicated Embedded Cluster installations, see [Exposing Services Using NodePorts](kurl-nodeport-services).

## Overview

When distributing an application, it is helpful to ensure that the person or process installing the application is able to easily verify that the application is running.

Networking and ingress is handled differently in each cluster, and this makes it difficult to provide a consistent application URL at installation. Additionally, the cluster operator might be required to create firewall rules before they can open the application.

For installations into existing clusters, KOTS automatically creates a port forward tunnel and exposes the Admin Console on port 8800 where it can be accessed by users at installation.

In addition to the 8800 Admin Console port, you can configure the KOTS Application custom resource to add one or more extra ports to the port forward tunnel so that users installing in exsting clusters can easily access your application at installation. For example, you can:
* List the primary application ports to provide one or more links directly to the application before ingress and firewalls are configured 
* List the ports for internal services, such as application admin controls and other services that are not exposed to all users

## Configure Port Forwarding

This section describes how to configure port forwarding for existing cluster installations by adding extra ports to the `ports` key in the KOTS Application custom resource.

The following example KOTS Application custom resource includes a `ports` key that allows users to access a `gitea` service at port 8888 on the local machine at installation: 

<GiteaKotsApp/>

As shown in the example above, the `ports` key has the following fields:

<ul>

<p><PortsServiceName/></p>

<PortsServicePort/>

<ServicePortNote/>

<PortsLocalPort/>

<PortsApplicationURL/>

</ul>

## Access Port-Forwarded Services

This section describes how users can access port-forwarded services.

### Command Line

Users can run [`kubectl kots admin-console`](/reference/kots-cli-admin-console-index) to open the KOTS port forward tunnel.

The `kots admin-console` command runs the equivalent of `kubectl port-forward svc/myapplication-service <local-port>:<remote-port>`, then prints a message with the URLs where the user can access the Admin Console and any port-forwarded services. For more information about the `kubectl port-forward` command, see [port-forward](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#port-forward) in the Kubernetes documentation.

For example:

```bash
kubectl kots admin-console --namespace gitea
```
```bash
• Press Ctrl+C to exit
• Go to http://localhost:8800 to access the Admin Console
• Go to http://localhost:8888 to access the application
```

### Admin Console

The following example shows an **Open App** button on the dashboard of the Admin Console for an application named Gitea:

![Admin Console dashboard with Open App link](/images/gitea-open-app.png)

[View a larger version of this image](/images/gitea-open-app.png)

## Add a Link to Port-Forwarded Services from the Admin Console

Adding a link to the port-forwarded service from the Admin Console dashboard requires additional configuration.

To add a link to a port-forwarded service on the Admin Console dashboard, add matching URLs to the `ports.applicationURL` field in the KOTS Application custom resource and the `descriptor.links.url` field in the Kubernetes SIG Application custom resource.

For more information, see [Adding Links to the Dashboard](/vendor/admin-console-adding-buttons-links). 

### Example: Bitnami Gitea Helm Chart with LoadBalancer Service

This example provides a KOTS Application custom resource and Kubernetes Application custom resource to configure port forwarding for the Bitnami Gitea Helm chart in existing cluster installations. To view the Gitea Helm chart source, see [bitnami/gitea](https://github.com/bitnami/charts/blob/main/bitnami/gitea) in GitHub.

To test this example:
1. Pull version 1.0.6 of the Gitea Helm chart from Bitnami:

    ```
    helm pull oci://registry-1.docker.io/bitnamicharts/gitea --version 1.0.6
    ```

1. Add the `gitea-1.0.6.tgz` chart archive to a new, empty release in the Vendor Portal along with the `kots-app.yaml`, `k8s-app.yaml`, and `gitea.yaml` files provided below. Promote to the channel that you use for internal testing.

    For more information, see [Managing Releases with the Vendor Portal](releases-creating-releases).

    <Tabs>
    <TabItem value="kots-app" label="kots-app.yaml" default>
    <h5>Description</h5>
    <p>Based on the <a href="https://github.com/bitnami/charts/blob/main/bitnami/gitea/templates/svc.yaml">templates/svc.yaml</a> and <a href="https://github.com/bitnami/charts/blob/main/bitnami/gitea/values.yaml">values.yaml</a> files in the Gitea Helm chart, the following KOTS Application custom resource adds port 3000 to the port forward tunnel and maps local port 8888. Port 3000 is the container port of the Pod where the <code>gitea</code> service runs.</p>
    <h5>YAML</h5>
    <GiteaKotsApp/>
    </TabItem>
    <TabItem value="k8s-app" label="k8s-app.yaml" default>
    <h5>Description</h5>
    <p>Using the value of <code>ports.applicationUrl</code> in <code>kots-app.yaml</code>, the Kubernetes Application custom resource below adds a link to the port-forwarded service from the Admin Console dashboard. The label to be used for the link in the Admin Console is "Open App".</p>
    <h5>YAML</h5>
    <GiteaK8sApp/>
    </TabItem>
    <TabItem value="helmchart" label="gitea.yaml" default>
    <h5>Description</h5>
    <p>The KOTS HelmChart custom resource provides instructions to KOTS about how to deploy the Helm chart. The <code>name</code> and <code>chartVersion</code> listed in the HelmChart custom resource must match the name and version of a Helm chart archive in the release. Each Helm chart archive in a release requires a unique HelmChart custom resource.</p>
    <h5>YAML</h5>
    <GiteaHelmChart/>
    </TabItem>
    </Tabs>

1. Install the release into an existing cluster and confirm that the service was port-forwarded successfully by clicking **Open App** on the Admin Console dashboard. For more information, see [Online Installation in Existing Clusters](/enterprise/installing-existing-cluster).