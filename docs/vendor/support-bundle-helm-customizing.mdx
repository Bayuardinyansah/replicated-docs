import SupportBundleAddLogs from "../partials/support-bundles/_support-bundle-add-logs.mdx"
import SupportBundleCustomCollectors from "../partials/support-bundles/_support-bundle-custom-collectors.mdx"
import SupportBundleAddAnalyzers from "../partials/support-bundles/_support-bundle-add-analyzers.mdx"
import ConfigmapNote from "../partials/preflights/_configmap-note.mdx"


# Customize Helm Support Bundles

Customizing a support bundle is unique to your application and depends on what kind of data you need to troubleshoot. This procedure provides a basic understanding and some key considerations to help guide you. For more information, see [Collecting Data](https://troubleshoot.sh/docs/collect/) and [Analyzing Data](https://troubleshoot.sh/docs/analyze/) in the Troubleshoot documentation.

### Specification Types

The following table can help guide you in deciding which options to use for support bundles.

#### Secrets

Replicated recommends using Secrets to provide support bundle specifications:

<table>
    <tr>
      <th>Use Cases</th>
      <td><p>Lets customers automatically discover all of the support bundle specifications as Secrets in a cluster.</p></td>
    </tr>
    <tr>
      <th>Advantages</th>
      <td><p>Does not require manual input of filenames when generating support bundles.</p><p>Can be used with custom labels.</p><p>Can contain private information.</p><p>Easier to distribute than other options because Secrets are co-located in the Helm chart.</p></td>
    </tr>
    <tr>
      <th>Supports Templating?</th>
      <td>Yes</td>
    </tr>
    <tr>
      <th>Limitations</th>
      <td><p>Not applicable</p></td>
    </tr>
  </table>

#### ConfigMaps

Lets you provide support bundle specifications using one or more ConfigMaps:

<table>
    <tr>
      <th>Use Cases</th>
      <td><p>Lets customer automatically discover all of the support bundle specifications in a cluster.</p></td>
    </tr>
    <tr>
      <th>Advantages</th>
      <td><p>Does not require manual input of filenames when generating support bundles.</p><p>Can be used with custom labels.</p></td>
    </tr>
    <tr>
      <th>Supports Templating?</th>
      <td>Yes</td>
    </tr>
    <tr>
      <th>Limitations</th>
      <td><p>Not secure for containing private information. Use Secrets for security instead.</p></td>
    </tr>
  </table>

#### YAML Files

Lets you provide support bundle specifications using one or more YAML files:

<table>
    <tr>
      <th>Use Cases</th>
      <td><p>Useful for air gap when customization is not needed. The vendor can send the customer a file to use.</p><p>Can help to troubleshoot air gap installations that fail because information can be gathered without installing a Secret.</p></td>
    </tr>
    <tr>
      <th>Advantages</th>
      <td><p>Easy to create.</p></td>
    </tr>
    <tr>
      <th>Supports Templating?</th>
      <td>No</td>
    </tr>
    <tr>
      <th>Limitations</th>
      <td><p>File names must be manually typed in to generate a support bundle, and there might be multiple files or long file names.</p><p>Customers must find out what the file names and paths are.</p></td>
    </tr>
  </table>

#### URLs

Lets you provide support bundle specifications using one or more URLs. For more information about using URLs, see [About Online Support Bundle Specifications](support-online-support-bundle-specs).

<table>
    <tr>
      <th>Use Cases</th>
      <td><p>The cluster can link to updated support bundle specifications online when the URI is included in the support bundle specification that is installed in the cluster.</p></td>
    </tr>
    <tr>
      <th>Advantages</th>
      <td><p>Allows vendors to update the support-bundle specification out-of-band from the application to provide notifications of possible issues, fixes, and prevention information.</p><p>If the URI is unavailable or unparseable, the support bundle is generated using the original specification in the cluster.</p><p>Easy to iterate against as a team.</p></td>
    </tr>
    <tr>
      <th>Supports Templating?</th>
      <td>No, the updated online specification cannot be templated.</td>
    </tr>
    <tr>
      <th>Limitations</th>
      <td><p>URLs must be manually typed in to generate a support bundle, and there might be multiple strings and long strings.</p><p>Vendors must provide customers with the URL strings.</p><p>Does not support air gap environments.</p></td>
    </tr>
  </table>

## Define Support Bundles as Secrets

Replicated recommends using Secrets to contain a support bundle specifications in your Helm chart. This method allows customers to automatically discover and generate a support bundle without specifying a long URL. Using Secrets also allows specifications to be templated using information in the `values.yaml` file.

<ConfigmapNote/>

To customize a support bundle as a Secret, create a specification using `kind: Secret`. You must include the following fields:

- `Label` - Label the secret definition as `troubleshoot.sh/kind: support-bundle`
- `stringData` - Specify a `stringData` field with a key named `support-bundle-spec`

The following example shows a support bundle specification as a Secret. For more examples, see the [Troubleshoot example repository](https://github.com/replicatedhq/troubleshoot/tree/main/examples/support-bundle) in GitHub.

```yaml
apiVersion: v1
kind: Secret
metadata:
  labels:
    troubleshoot.sh/kind: support-bundle
  name: {{ .Release.Name }}-support-bundle
  namespace: {{ .Release.Namespace }}
type: Opaque
stringData:
  # This is the support bundle spec that will be used to generate the support bundle
  # Notes: we use {{ .Release.Namespace }} to ensure that the support bundle is scoped to the release namespace
  # We can use any of Helm's templating features here, including {{ .Values.someValue }}
  support-bundle-spec: |
    apiVersion: troubleshoot.sh/v1beta2
    kind: SupportBundle
    metadata:
      name: support-bundle
    spec:
      collectors:
        - clusterInfo: {}
        - clusterResources: {}
        - logs:
            selector:
              - app=someapp
              - component=nginx
            namespace: {{ .Release.Namespace }}
            limits:
              maxAge: 720h # 30*24
              maxLines: 10000
              maxBytes: 5000000
        - logs:
            collectorName: all-logs
            name: all-logs
        - runPod:
            collectorName: "static-hi"
            podSpec:
              containers:
              - name: static-hi
                image: alpine:3
                command: ["echo", "hi static!"]
      analyzers:
        - clusterVersion:
            outcomes:
              - fail:
                  when: "< 1.22.0"
                  message: The application requires at least Kubernetes 1.22.0 or later
                  uri: https://kubernetes.io
              - warn:
                  when: "< 1.23.0"
                  message: Your cluster meets the minimum version of Kubernetes, but we recommend you update to 1.23.0 or later.
                  uri: https://kubernetes.io
              - pass:
                  message: Your cluster meets the recommended and required versions of Kubernetes.
        - nodeResources:
            checkName: Must have at least 3 nodes in the cluster
            outcomes:
              - fail:
                  when: "count() < 3"
                  message: This application requires at least 3 nodes
              - warn:
                  when: "count() < 5"
                  message: This application recommends at last 5 nodes.
              - pass:
                  message: This cluster has enough nodes.
        - nodeResources:
            checkName: Total CPU Cores in the cluster is 4 or greater
            outcomes:
            - fail:
                when: "sum(cpuCapacity) < 4"
                message: The cluster must contain at least 4 cores
            - pass:
                message: There are at least 4 cores in the cluster
        - nodeResources:
            checkName: Each node must have at least 40 GB of ephemeral storage
            outcomes:
            - fail:
                when: "min(ephemeralStorageCapacity) < 40Gi"
                message: Nodes in this cluster do not have at least 40 GB of ephemeral storage.
                uri: https://domain.com/docs/system-requirements
            - warn:
                when: "min(ephemeralStorageCapacity) < 100Gi"
                message: Nodes in this cluster are recommended to have at least 100 GB of ephemeral storage.
                uri: https://domain.com/docs/system-requirements
            - pass:
                message: The nodes in this cluster have enough ephemeral storage.
        - ingress:
            namespace: default
            ingressName: connect-to-me
            outcomes:
              - fail:
                  message: The ingress isn't ingressing
              - pass:
                  message: All systems ok on ingress
        - deploymentStatus:
            name: api
            namespace: default
            outcomes:
              - fail:
                  when: "< 1"
                  message: The API deployment does not have any ready replicas.
              - warn:
                  when: "= 1"
                  message: The API deployment has only a single ready replica.
              - pass:
                  message: There are multiple replicas of the API deployment ready.
        - textAnalyze:
            checkName: Said hi!
            fileName: /static-hi.log
            regex: 'hi static'
            outcomes:
              - fail:
                  message: Didn't say hi.
              - pass:
                  message: Said hi!
```

### Cluster Collectors

You can add the `clusterInfo` and `clusterResources` collectors if you want to collect a large amount of data to help with installation and debugging. For `clusterResources`, you can add the default namespace or additional namespaces to the `namespaces` field.

### Pod Log Collectors

<SupportBundleAddLogs/>

### Other Recommended Collectors

<SupportBundleCustomCollectors/>

### Analyzers

<SupportBundleAddAnalyzers/>

### Redactors

Troubleshoot has built-in redactors to prevent sensitive data from being collected when support bundles are generated. You can add more redactors if needed. For more information, see [Redacting Data](https://troubleshoot.sh/docs/redact/) in the Troubleshoot documentation.

## Next Steps

- When using Secrets, you can also add Helm templates for the specification in the `values.yaml` file.

- Test your support bundle in a development environment. For more information, see [Generating Support Bundles](support-bundle-generating).