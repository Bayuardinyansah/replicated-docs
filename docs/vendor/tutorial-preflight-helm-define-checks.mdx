import DependencyYaml from "../partials/replicated-sdk/_dependency-yaml.mdx"

# Step 2: Define and Test Preflight Checks

Create a preflight specification that fails if the cluster is running a version of Kubernetes earlier than 1.23.0.

According to the Gitea installation requirements listed under [Prerequisites](https://github.com/bitnami/charts/tree/main/bitnami/gitea#prerequisites), Gitea requires Kubernetes 1.23.0 or later. 

To create a preflight check for the Gitea application:

1. In your local filesystem, create a file named `gitea-preflights.yaml`:

   ```bash
   touch gitea-preflights.yaml
   ```

1. In the `gitea-preflights.yaml` file, paste the following YAML:

   ```yaml
   apiVersion: troubleshoot.sh/v1beta2
   kind: Preflight
   metadata:
     name: gitea-preflight-checks
   spec:
     analyzers:
       - clusterVersion:
           outcomes:
             - fail:
                 when: "< 1.23.0"
                 message: |-
                   Your cluster is running a version of Kubernetes that is not supported and your installation will not succeed. To continue, upgrade your cluster to Kubernetes 1.23.0 or later.
                 uri: https://www.kubernetes.io
             - pass:
                 message: Your cluster is running the recommended version of Kubernetes.
   ```

   This YAML defines a preflight check that fails if the target cluster is running a version of Kubernetes earlier than 1.23.0. The preflight check includes a message to the user that describes the failure and lists the required Kubernetes version.

1. Run the preflight check with the preflight kubectl plugin to test:

   1. Install the preflight kubectl plugin:

     ```bash
     curl https://krew.sh/preflight | bash
     ```

   1. Run preflight checks:

     ```bash
     kubectl preflight ./gitea-preflights.yaml
     ```  

## Next Step

Add the preflight check specification to the Gitea chart.

## Related Topics

* [Defining Preflight Checks](/vendor/preflight-defining)
* [Running Preflight Checks](/vendor/preflight-running)