import DownloadPortal from "../partials/kots/_download-portal-about.mdx"

# Downloading Air Gap Bundles

This topic describes how to build and download air gap bundles for installations with the Replicated Embedded Cluster, KOTS, and kURL installers.

## About Air Gap Bundles

_Air gap bundles_ are required to install applications in air gap environments. Air gap bundles contain the assets needed to install and run applications in an environment that has no outbound internet access.

The air gap bundles required for installation vary depending on the Replicated installer that is used:

* **Replicated Embedded Cluster**: Installations with Embedded Cluster require a single Embedded Cluster air gap bundle. The Embedded Cluster air gap bundle contains:

    * An `embedded-cluster` directory with the assets needed to install the infrastructure (Embedded Cluster/k0s and any [extensions](/reference/embedded-config#extensions))
    * All the assets contained in the air gap bundle for the given application release (application images, manifests, and dependencies)

* **Replicated KOTS in Existing Cluster**: Installations with KOTS in an existing cluster require the following air gap bundles:
    * **Application release air gap bundle**: Contains the assets required to install the given application release (application images, manifests, and dependencies).
    * **KOTS Admin Console bundle**: Contains the container images for the Replicated KOTS Admin Console. 

* **Replicated kURL**: Installations with kURL require the following air gap bundles:
    * **Application release air gap bundle**: Contains the assets required to install the given application release (application images, manifests, and dependencies)
    * **kURL bundle**: Contains the open source components to run the cluster, including the container runtime, Kubernetes, the KOTS Admin Console, the kURL image registry and a number of other [kURL add-ons](https://kurl.sh/add-ons).
    
      <details>
      <summary>Why is the kURL bundle separate from the `.airgap` bundle?</summary>

        * The kURL bundle can get quite large, so this method lets you update your application with a smaller bundle size.
        * Whereas air gap bundles for an application often need to be rebuilt with each new release, kURL air gap bundles only need to be built when the underlying cluster components or add-ons must be updated.
      </details>  

## Download the Embedded Cluster Bundle {#ec-bundle}

This section describes how to download the air gap bundle for installations with Embedded Cluster using the Replicated app service. Downloading the Embedded Cluster air gap bundle is done as part of installation. For more information, see [Air Gap Installation with Embedded Cluster](/enterprise/installing-embedded-air-gap).

To download the Embedded Cluster air gap bundle:

1. Build the air gap bundle for the target release on the channel's **Release history** page. For more information, see [Build the Application Release Bundle in the Vendor Portal](#air-gap-bundle) below.

   <details>
      <summary>Why do I need to build the release air gap bundle if it is not required for Embedded Cluster air gap installations?</summary>

      Building the bundle for the release is required because, if you attempt to download the Embedded Cluster air gap bundle without first bulding the release bundle, the API will return the Embedded Cluster tarball without including an `.airgap` bundle. For more information, see [Limitations and Known Issues](/enterprise/installing-embedded-air-gap#limitations-and-known-issues) in _Air Gap Installation with Embedded Cluster_.

      </details>

1. Run the following command to download the Embedded Cluster air gap bundle using the Replicated app service:

    ```bash
    curl -f https://replicated.app/embedded/APP_SLUG/CHANNEL_SLUG?airgap=true -H "Authorization: LICENSE_ID" -o APP_SLUG-CHANNEL_SLUG.tgz
    ```
    Where:
    * `APP_SLUG` is the unique application slug
    * `CHANNEL_SLUG` is the slug for the channel where the release is promoted
    * `LICENSE_ID` is the customer's license ID

    This will produce three files:
    * The installer
    * The license
    * The air gap bundle (`APP_SLUG.airgap`)

## Build the Application Release Bundle in the Vendor Portal {#air-gap-bundle}

This section describes how to build and download the air gap bundle for the application release from the Vendor Portal.

For information about building and downloading air gap bundles with the Vendor API v3, see [Trigger airgap build for a channel's release](https://replicated-vendor-api.readme.io/reference/channelreleaseairgapbuild) and [Get airgap bundle download URL for the active release on the channel](https://replicated-vendor-api.readme.io/reference/channelreleaseairgapbundleurl) in the Vendor API v3 documentation.

For information about how to download the air gap bundle from the Replicated Download Portal, see [Download Air Gap Bundles from the Download Portal](#download-portal) below.

To build and download the air gap bundle for a release:

1. In the [Vendor Portal](https://vendor.replicated.com), go to **Channels**. On the target channel, click **Release history**.

    <img alt="Release history link on a channel card" src="/images/release-history-link.png" width="400px"/>

    [View a larger version of this image](/images/release-history-link.png)

1. On the **Release history** page, click **Build** to build the air gap bundle.

    :::note
    By default, the Stable and Beta channels automatically build air gap bundles on new releases.
    To edit this functionality on any channel, enable or disable the **Automatically create airgap builds for all releases in this channel** toggle in the channel settings.
    :::

    ![Build button on the Release history page](/images/release-history-build-airgap-bundle.png)

    [View a larger version of this image](/images/release-history-build-airgap-bundle.png)

1. (Optional) After the bundle is built, click **Download Bundle**. The bundle is named `APP_SLUG.airgap`.

1. (Optional) View the contents of the bundle: 

     ```bash
     tar -zxvf `APP_SLUG.airgap`
     ```
     Where `APP_SLUG.airgap` is the filename of the bundle that you downloaded.

## Download the KOTS Admin Console Bundle

Air gap installations with KOTS in existing clusters require the `kotsadm.tar.gz` air gap bundle, which includes the images for the Admin Console.

To download the KOTS Admin Console bundle, do one of the following:

* Download the `kotsadm.tar.gz` air gap bundle on the [Releases](https://github.com/replicatedhq/kots/releases) page in the kots repository in GitHub.

   :::note
   The version of the `kotsadm.tar.gz` air gap bundle used must be compatible with the version of the `.airgap` bundle for the given application release.
   :::

* Alternatively, download the `kotsadm.tar.gz` air gap bundle from the Replicated Download Portal. See [Download Air Gap Bundles from the Download Portal](#download-portal) below. 

## Download the kURL Bundle {#installer-bundle}

Air gap installations with kURL require the kURL `.tar.gz` air gap bundle, which includes the components needed to run the kURL cluster and install the application with KOTS.

kURL air gap bundles can be downloaded from the channel where the given release is promoted. Alternatively, you can also download the kURL air gap bundle from the Replicated Download Portal. For more information, see [Download Air Gap Bundles from the Download Portal](#download-portal) below. 

#### Download the kURL Bundle for the Stable Channel

To download the kURL air gap bundle for the Stable channel:

```shell
export REPLICATED_APP=APP_SLUG
curl -LS https://k8s.kurl.sh/bundle/$REPLICATED_APP.tar.gz -o $REPLICATED_APP.tar.gz
```

Where `APP_SLUG` is the unqiue slug for the application. You can find the slug on the **Application Settings** page in the [Vendor Portal](https://vendor.replicated.com/apps). For more information, see [Get the Application Slug](/vendor/vendor-portal-manage-app#slug) in _Managing Applications_.

#### Download the kURL Bundle for Other Channels

To download the kURL bundle for channels other than Stable:

1. Run the following command to get the air gap URL:

    ```shell
    replicated channel inspect CHANNEL
    ```
    Replace `CHANNEL` with the exact name of the target channel, which can include uppercase letters or special characters, such as `Unstable` or `my-custom-channel`.

    The output shows valid URLs for existing cluster, embedded kURL cluster, and air gap installations. For example:

    ```bash
    ID: 2cQZqq44qwTH
    NAME: Beta
    DESCRIPTION:
    RELEASE:
    VERSION:
    EXISTING:

        curl -fsSL https://kots.io/install | bash
        kubectl kots install gitea/beta

    EMBEDDED:

        curl -fsSL https://k8s.kurl.sh/gitea-beta | sudo bash

    AIRGAP:

        curl -fSL -o gitea-beta.tar.gz https://k8s.kurl.sh/bundle/gitea-beta.tar.gz
        # ... scp or sneakernet gitea-beta.tar.gz to airgapped machine, then
        tar xvf gitea-beta.tar.gz
        sudo bash ./install.sh airgap
    ```
    
1. In the output of the command, copy the `curl` command with the air gap URL.

## Download Bundles from the Download Portal {#download-portal}

<DownloadPortal/>

:::note
Air gap bundles for Embedded Cluster are not available in the Download Portal. See [Download the Embedded Cluster Bundle](#ec-bundle) above.
:::

To download air gap bundles from the Download Portal:

1. In the [Vendor Portal](https://vendor.replicated.com), on the **Customers** page, click on the name of the customer.

1. On the **Manage customer** page, enable the **Airgap Download Enabled** option.

1. In the **Download portal** section, generate or create a password. Copy the password to your clipboard and click **Save**.

     <img alt="download portal link" src="/images/download-portal-link.png" width="650px"/>

     [View a larger version of this image](/images/download-portal-link.png)

1. Click **Visit download portal** and log in.

     The following is an example of the download portal for an air gap customer:

     ![download portal for existing cluster air gap installs](/images/download-portal-existing-cluster.png)

     [View a larger version of this image](/images/download-portal-existing-cluster.png)

1. On the left side of the screen, select one of the following:
     * **Bring my own cluster**: View the air gap bundles for existing cluster installations.
     * **Embedded cluster**: View the air gap bundles for installations with kURL.

1. Under **Select application version**, use the dropdown to select the target application release version. The download portal automatically makes the correct air gap bundles available for download based on the selected application version.

1. Click the download button to download each air gap bundle.     