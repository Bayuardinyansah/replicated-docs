import SupportBundleAddLogs from "../partials/support-bundles/_support-bundle-add-logs.mdx"
import SupportBundleCustomCollectors from "../partials/support-bundles/_support-bundle-custom-collectors.mdx"
import SupportBundleAddAnalyzers from "../partials/support-bundles/_support-bundle-add-analyzers.mdx"
import PreflightsHelmGuidance from "../partials/preflights/_preflights-helm-guidance.mdx"


# Customize Helm Support Bundles

Customizing a support bundle is unique to your application and depends on what kind of data you need to troubleshoot. This procedure provides a basic understanding and some key considerations to help guide you. For more information, see [Collecting Data](https://troubleshoot.sh/docs/collect/) and [Analyzing Data](https://troubleshoot.sh/docs/analyze/) in the Troubleshoot documentation.

Additionally, this procedure shows using a Secret to contain a support bundle specification with your Helm chart, which allows customers to automatically discover and generate a support bundle without specifying a long URL. Using a Secret also allows the specification to be templated using information in the `values.yaml` file.

<PreflightsHelmGuidance/>

To customize a support bundle as a Secret:

1. Create a Secret (`kind: Secret`) containing the specification. Alternatively, you can use a ConfigMap (`kind: configMap`) if the specification will not collect private information from the cluster.

  You must include the following:

    - `Label` - Label the secret definition as `troubleshoot.sh/kind: support-bundle`
    - `stringData` - Specify a `stringData` field with a key named `support-bundle-spec`

    **Example:**

    ```yaml
    apiVersion: v1
    kind: Secret
    metadata:
      labels:
        troubleshoot.sh/kind: support-bundle
      name: {{ .Release.Name }}-support-bundle
      namespace: {{ .Release.Namespace }}
    type: Opaque
    stringData:
      # This is the support bundle spec that will be used to generate the support bundle
      # Notes: we use {{ .Release.Namespace }} to ensure that the support bundle is scoped to the release namespace
      # We can use any of Helm's templating features here, including {{ .Values.someValue }}
      support-bundle-spec: |
        apiVersion: troubleshoot.sh/v1beta2
        kind: SupportBundle
        metadata:
          name: support-bundle
        spec:
          collectors:
            - clusterInfo: {}
            - clusterResources: {}
            - logs:
                selector:
                  - app=someapp
                namespace: {{ .Release.Namespace }}
    ```

1. (Optional) Add the `clusterInfo` and `clusterResources` collectors to collect a large amount of data to help with installation and debugging. For `clusterResources`, you can add the default namespace or additional namespaces to the `namespaces` field.

1. <SupportBundleAddLogs/>

      **Example:**

      ```yaml
      stringData:
        support-bundle-spec: |-
          spec:
            collectors:
            - logs:
              selector:
                - app=api
              namespace: default
              limits:
                maxLines: 10000
      ```

1. <SupportBundleCustomCollectors/>

1. <SupportBundleAddAnalyzers/>

1. (Optional) Add redactors to prevent sensitive data from being collected when support bundles are generated. For more information, see [Redacting Data](https://troubleshoot.sh/docs/redact/) in the Troubleshoot documentation.

1. When using Secrets, you can also add Helm templates for the specification in the `values.yaml` file.

1. Test your support bundle in a development environment. For more information, see [Generating Support Bundles](support-bundle-generating).

## Example

The following example shows a support bundle specification using a Secret. For more examples, see the [Troubleshoot example repository](https://github.com/replicatedhq/troubleshoot/tree/main/examples) in GitHub.

```yaml
apiVersion: v1
kind: Secret
metadata:
  labels:
    troubleshoot.sh/kind: support-bundle
  name: {{ .Release.Name }}-support-bundle
  namespace: {{ .Release.Namespace }}
type: Opaque
stringData:
  # This is the support bundle spec that will be used to generate the support bundle
  # Notes: we use {{ .Release.Namespace }} to ensure that the support bundle is scoped to the release namespace
  # We can use any of Helm's templating features here, including {{ .Values.someValue }}
  support-bundle-spec: |
    apiVersion: troubleshoot.sh/v1beta2
    kind: SupportBundle
    metadata:
      name: support-bundle
    spec:
      hostCollectors:
        - hostOS: {}
      collectors:
        - clusterInfo: {}
        - clusterResources: {}
        - logs:
            selector:
              - app=someapp
              - component=nginx
            namespace: {{ .Release.Namespace }}
            limits:
              maxAge: 720h # 30*24
              maxLines: 10000
              maxBytes: 5000000
        - logs:
            collectorName: all-logs
            name: all-logs
        - runPod:
            collectorName: "static-hi"
            podSpec:
              containers:
              - name: static-hi
                image: alpine:3
                command: ["echo", "hi static!"]
      analyzers:
        - clusterVersion:
            outcomes:
              - fail:
                  when: "< 1.16.0"
                  message: The application requires at least Kubernetes 1.16.0 or later
                  uri: https://kubernetes.io
              - warn:
                  when: "< 1.17.0"
                  message: Your cluster meets the minimum version of Kubernetes, but we recommend you update to 1.17.0 or later.
                  uri: https://kubernetes.io
              - pass:
                  message: Your cluster meets the recommended and required versions of Kubernetes.
        - customResourceDefinition:
            customResourceDefinitionName: rook
            outcomes:
              - fail:
                  message: The Rook CRD was not found in the cluster.
                  uri: https://kurl.sh/docs/add-ons/rook/some/path/that/does/not/exist/for/the/sake/of/having/a/very/long/url.md
              - pass:
                  message: Rook is installed and available.
        - containerRuntime:
            outcomes:
              - fail:
                  when: "== docker"
                  message: The application does not support docker
              - pass:
                  message: A supported container runtime was found
        - storageClass:
            checkName: Required storage classes
            storageClassName: "microk8s-hostpath"
            outcomes:
              - fail:
                  message: The microk8s storage class thing was not found
              - pass:
                  message: All good on storage classes
        - nodeResources:
            checkName: Must have at least 3 nodes in the cluster
            outcomes:
              - fail:
                  when: "count() < 3"
                  message: This application requires at least 3 nodes
              - warn:
                  when: "count() < 5"
                  message: This application recommends at last 5 nodes.
              - pass:
                  message: This cluster has enough nodes.
        - nodeResources:
            checkName: Total CPU Cores in the cluster is 4 or greater
            outcomes:
            - fail:
                when: "sum(cpuCapacity) < 4"
                message: The cluster must contain at least 4 cores
            - pass:
                message: There are at least 4 cores in the cluster
        - nodeResources:
            checkName: Each node must have at least 40 GB of ephemeral storage
            outcomes:
            - fail:
                when: "min(ephemeralStorageCapacity) < 40Gi"
                message: Nodes in this cluster do not have at least 40 GB of ephemeral storage.
                uri: https://kurl.sh/docs/install-with-kurl/system-requirements
            - warn:
                when: "min(ephemeralStorageCapacity) < 100Gi"
                message: Nodes in this cluster are recommended to have at least 100 GB of ephemeral storage.
                uri: https://kurl.sh/docs/install-with-kurl/system-requirements
            - pass:
                message: The nodes in this cluster have enough ephemeral storage.
        - ingress:
            namespace: default
            ingressName: connect-to-me
            outcomes:
              - fail:
                  message: The ingress isn't ingressing
              - pass:
                  message: All systems ok on ingress
        - deploymentStatus:
            name: api
            namespace: default
            outcomes:
              - fail:
                  when: "< 1"
                  message: The API deployment does not have any ready replicas.
              - warn:
                  when: "= 1"
                  message: The API deployment has only a single ready replica.
              - pass:
                  message: There are multiple replicas of the API deployment ready.
        - textAnalyze:
            checkName: Said hi!
            fileName: /static-hi.log
            regex: 'hi static'
            outcomes:
              - fail:
                  message: Didn't say hi.
              - pass:
                  message: Said hi!
```