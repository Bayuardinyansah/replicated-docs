import SDKOverview from "../partials/replicated-sdk/_overview.mdx"
import BestPractices from "../partials/getting-started/_best-practices.mdx"
import Community from "../partials/getting-started/_community.mdx"
import Prerequisites from "../partials/getting-started/_prerequisites.mdx"
import PackageSdk from "../partials/getting-started/_package-sdk.mdx"
import Preflights from "../partials/getting-started/_preflights.mdx"
import SupportBundles from "../partials/getting-started/_support-bundles.mdx"
import DependencyYaml from "../partials/replicated-sdk/_dependency-yaml.mdx"
import CiCd from "../partials/getting-started/_ci-cd.mdx"
import CustomMetrics from "../partials/getting-started/_custom-metrics.mdx"
import CustomChannels from "../partials/getting-started/_custom-channels.mdx"
import CustomDomains from "../partials/getting-started/_custom-domains.mdx"
import HelmPackage from "../partials/helm/_helm-package.mdx"
import TestYourChanges from "../partials/getting-started/_test-your-changes.mdx"
import EmbeddedConfig from "../partials/embedded-cluster/_default-config.mdx"
import Requirements from "../partials/embedded-cluster/_requirements.mdx"
import Cluster from "../partials/getting-started/_setup-cluster.mdx"
import ImageRegistry from "../partials/getting-started/_connect-image-registry.mdx"
import CustomizeSupportBundles from "../partials/getting-started/_customize-support-bundles.mdx"
import AboutPreflightsSupportBundles from "../partials/preflights/_overview.mdx"
import CustomEntitlements from "../partials/getting-started/_add-license-entitlements.mdx"
import CreateApp from "../partials/getting-started/_create-app.mdx"
import EnableProxyService from "../partials/getting-started/_enable-proxy-service.mdx"

# KOTS and Embedded Cluster Onboarding 

This topic describes how to onboard applications that will support installation with Replicated KOTS, Replicated Embedded Cluster, and the Helm CLI.

If your application will support Helm CLI installations only, see [Helm CLI-Only Onboarding](/vendor/replicated-onboarding).

## Before You Begin

This section includes guidance and prerequisites to review before you begin onboarding your application.

### Prerequisites

<Prerequisites/>

* <Cluster/>

* Ensure that you have access to a VM that meets the requirements for Embedded Cluster:

  <Requirements/>

### Best Practices and Recommendations

<BestPractices/>

### Getting Help from the Community

<Community/>

## Onboard

### Task 1: Create An Application

<CreateApp/>

### Task 2: Connect Your Image Registry

<ImageRegistry/>

### Task 3: Create and Install the Initial Release {#first-release}

As part of the initial release for your application, you will add your Helm chart archive, KOTS HelmChart custom resource, and Embedded Cluster Config to the release. These are the minimum files required to install a Helm chart with Embedded Cluster.

To create and install the initial release for your application:

1. <PackageSdk/>

   <DependencyYaml/>   

1. Update dependencies and package the chart as a `.tgz` file:

    <HelmPackage/>

1. Add the `.tgz` file to a release. For more information, see [Managing Releases with the Vendor Portal](releases-creating-releases) or [Managing Releases with the CLI](releases-creating-cli).

1. In the release, add and configure the KOTS HelmChart Custom Resource by completing the workflow in [Configuring the HelmChart Custom Resource](helm-native-v2-using). The KOTS HelmChart custom resource is required to install Helm charts with KOTS and Embedded Cluster. It provides instructions to KOTS about how to deploy the given Helm chart.

    :::note
    If your application is deployed as multiple Helm charts, add a separate `.tgz` chart archive and HelmChart custom resource for each chart.
    :::

1. Add the following default Embedded Cluster Config to the release to support installations on VMs or bare metal servers with the Replicated Embedded Cluster installer:

    <EmbeddedConfig/>
    
    For more information, see [Using Embedded Cluster](/vendor/embedded-overview).

1. Promote the release to the Unstable channel. For more information, see [Managing Releases with the Vendor Portal](releases-creating-releases) or [Managing Releases with the CLI](releases-creating-cli).

1. Install the release:

   1. Install with Embedded Cluster on a VM. See [Download the Embedded Cluster Binary](/vendor/embedded-overview#download-the-embedded-cluster-binary) and [Install](/vendor/embedded-overview#install) in _Using Embedded Cluster_.

   1. Install in an existing cluster with KOTS. See [Online Installation in Existing Clusters](/enterprise/installing-existing-cluster).

After successfully installing the initial release both on a VM and in an existing cluster, go to the next task. You will continue to iterate on this release throughout the rest of the onboarding process.

### Task 4: Customize the KOTS Admin Console {#admin-console}

The KOTS Application custom resource and the Kubernetes SIG Application custom resource can be configured to customize the Admin Console experience for your application.

#### Task 4a: Add Application Name, Icon, and Status Informers

To add an application name, icon, and status informers:

1. In a new release, add the KOTS Application custom resource to add an application name, icon, and status informers.

   **Example:**

    ```yaml
    apiVersion: kots.io/v1beta1
    kind: Application
    metadata:
      name: gitea
    spec:
      title: Gitea
      icon: https://raw.githubusercontent.com/cncf/artwork/master/projects/kubernetes/icon/color/kubernetes-icon-color.png
      statusInformers:
        - deployment/gitea
    ```
    For more information, see:
    * [Application](/reference/custom-resource-application)
    * [Enabling and Understanding Application Status](/vendor/insights-app-status)

1. <TestYourChanges/>

#### Task 4b: Add Application Links to the Dashboard

1. In a new release, configure the Kubernetes SIG Application custom resource to add one or more links to your application on the Admin Console dashboard.

    **Example:**

    ```yaml
    apiVersion: app.k8s.io/v1beta1
    kind: Application
    metadata:
      name: "gitea"
    spec:
      descriptor:
        links:
          - description: Open App
            url: ""
    ``` 

    For more information, see [Adding Application Links to the Dashboard](/vendor/admin-console-adding-buttons-links).

1. <TestYourChanges/>

### Task 5: Set Up the Admin Console Config Screen and Map to Helm Values

The KOTS Admin Console config screen is used to collect required and optional application configuration values from your users. User-supplied values provided on the config screen can be mapped to your Helm values.

:::note
Before you begin this task, Replicated recommends that you complete the [Set Helm Values with KOTS](/vendor/tutorial-config-setup) tutorial to learn how to map user-supplied values from the Admin Console config screen to a Helm chart.
:::

To set up the Admin Console Config screen for your application:

1. In a new release, add the KOTS Config custom resource. Include groups and items in the KOTS Config custom resource based on the values that you need to collect from users.

    **Example:**

    ```yaml
    apiVersion: kots.io/v1beta1
    kind: Config
    metadata:
      name: my-application
    spec:
      groups:
        - name: example_group
          title: Example Group
          items:
            - name: example_item
              title: Example Item
              type: text
              default: "Hello World"
    ```

    For more information, see:
    * [Creating and Editing Configuration Fields](/vendor/admin-console-customize-config-screen) 
    * [Using Conditional Statements in Configuration Fields](/vendor/config-screen-conditional)  
    * [Config](/reference/custom-resource-config)  

1. <TestYourChanges/>

1. In a new release, configure the `values` key in the KOTS HelmChart custom resource to map the fields in the KOTS Config custom resource to your Helm values.

   For more information, see:
   * [Mapping User-Supplied Values](/vendor/config-screen-map-inputs).
   * [Tutorial: Set Helm Chart Values with KOTS](/vendor/tutorial-config-setup).
   * [`values`](/reference/custom-resource-helmchart-v2#values) in _HelmChart v2_

1. <TestYourChanges/>

1. Continue to create and test new releases with new config fields until you are ready to move on to the next task.

### Task 6: Add Preflight Checks and Support Bundles

<AboutPreflightsSupportBundles/>

#### Task 6a: Define Preflights 

<Preflights/>

#### Task 6b: Add the Default Support Bundle Spec

<SupportBundles/>

### Task 7: Alias Replicated Endpoints with Custom Domains

<CustomDomains/>

### Task 8: Add and Query Custom License Entitlements

<CustomEntitlements/>

For more information, see:
* [Managing Custom License Fields](/vendor/licenses-adding-custom-fields)
* [Querying Entitlements with the Replicated SDK API](/vendor/licenses-reference-sdk)
* [Checking Entitlements in Preflights with KOTS Template Functions](/vendor/licenses-referencing-fields)
* [Verifying License Field Signatures with the Replicated SDK API](/vendor/licenses-verify-fields-sdk-api)
* [Creating and Managing Customers](/vendor/releases-creating-customer)
* [Developing Against the SDK API](/vendor/replicated-sdk-development)

## Next Steps

After completing the main onboarding tasks, Replicated recommends that you also complete the following additional tasks to integrate other Replicated features with your application. You can complete these next recommended tasks in any order.

### Test Helm CLI Installations

Helm charts distributed with Replicated can be installed with the KOTS and Embedded Cluster installers, or with the Helm CLI. It is not necessary to create separate releases for each installation method. 

:::note
Before you test Helm CLI installations for your application, Replicated recommends that you complete the [Deploy a Helm Chart with KOTS and the Helm CLI](tutorial-kots-helm-setup) tutorial to learn how to install a single release with both KOTS and the Helm CLI in an existing cluster.
:::

To support Helm CLI installations:

<EnableProxyService/>

### Add Support for Air Gap Installations

KOTS and Embedded Cluster both support installations in _air gap_ environments with no outbound internet access. Users can install in air gap environments by providing air gap bundles that contain the required images. 

To add support for air gap installations:

1. In the KOTS HelmChart custom resource, configure the `builder` key. The Vendor Portal uses the values provided in the `builder` key to build the `.airgap` bundle for the release. See [Packaging Air Gap Bundles for Helm Charts](/vendor/helm-packaging-airgap-bundles).

    :::note
    If the default values in your Helm chart already enable all the images needed to successfully deploy the chart, then you do not need to configure the `builder` key.
    :::

1. If you have not done so already as part of [Task 0: Create and Install the Initial Release](#first-release), ensure that the `values` key in the KOTS HelmChart custom resource correctly rewrites images for air gap installations. See [Rewrite Image Names](/vendor/helm-native-v2-using#rewrite-image-names) in _Configuring the HelmChart Custom Resource v2_.

1. Create a customer with the **Airgap Download Enabled** entitlement enabled so that you can test air gap installations.

1. Download the air gap bundle for Embedded Cluster installations, then install with Embedded Cluster on a VM. See [Installing in Air Gap Environments with Embedded Cluster](/enterprise/installing-embedded-air-gap).

1. Download the `.airgap` bundle for the release and the KOTS air gap bundle. You can download both bundles from the Download Portal for the target customer. See [Building Air Gap Bundles](/vendor/releases-download-airgap-bundles).

1. Install in an existing cluster. See [Air Gap Installation in Existing Clusters](/enterprise/installing-existing-cluster-airgapped).

### Configure Backup and Restore

Enable backup and restore with Velero for your application so that users can back up and restore their KOTS Admin Console and application data. 

There are different steps to configure backup and restore for Embedded Cluster and for existing cluster installations with KOTS:
* To configure the disaster recovery feature for Embedded Cluster, see [Disaster Recovery for Embedded Cluster](/vendor/embedded-disaster-recovery)
* To configure the snapshots feature for existing cluster KOTS installations, see [Configuring Backup and Restore](snapshots-configuring-backups).

### Customize the Default Support Bundle Spec

<CustomizeSupportBundles/>

### Add Custom Metrics

<CustomMetrics/>

### Integrate with CI/CD

<CiCd/>

### Customize Release Channels

<CustomChannels/>