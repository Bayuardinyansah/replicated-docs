import PreflightsAddAnalyzers from "../partials/preflights/_preflights-add-analyzers.mdx"
import PreflightsAddStrict from "../partials/preflights/_preflights-add-strict.mdx"
import PreflightsSpecLocations from "../partials/preflights/_preflights-spec-locations.mdx"
import SecretsConfig from "../partials/preflights/_secrets-config.mdx"
import PreflightsAbout from "../partials/preflights/_preflights-about.mdx"
import PreflightsDefine from "../partials/preflights/_preflights-define.mdx"
import PreflightsDefineXref from "../partials/preflights/_preflights-define-xref.mdx"
import PreflightsCrNote from "../partials/preflights/_preflights-cr-note.mdx"
import AnalyzersNote from "../partials/preflights/_analyzers-note.mdx"
import RedactorsAbout from "../partials/redactors/_redactors-about.mdx"
import PreflightSbHelmTemplates from "../partials/preflights/_preflight-sb-helm-templates.mdx"


# Define Preflight Checks for Helm Installations

This topic provides a basic understanding and some key considerations about preflight checks for Helm installations to help guide you in defining them for your application.

## About Helm Preflight Checks

<PreflightsAbout/>

Preflight checks run using a `helm template` command before running the installation to confirm the target cluster has the resources required for a successful installation.

## Input Kind

When you run `helm template` command as stdin, the command filters the stream and runs the following inputs:

-  Secret (`kind: Secret`)
-  ConfigMap (`kind: ConfigMap`)
-  Preflight custom resource (`kind: Preflight`)

All of these input options allow customization of preflight checks based on values unique to the customer, using Helm templates with conditional statements.

Secrets and Config maps are installed in the cluster. Preflight custom resources cannot be installed in the cluster, and so must be wrapped in a condition.

## Create a Secret

<SecretsConfig/> 

You must include the following:

- `Label` - Label the secret definition as `troubleshoot.sh/kind: preflight`
- `stringData` - Specify a `stringData` field with a key named `preflight.yaml` so that the preflight binary can use this Secret when it runs from the CLI
- `{{ .Release.Namespace }}` to ensure that the specification is scoped to the release namespace.

```yaml
apiVersion: v1
kind: Secret
metadata:
  labels:
    troubleshoot.sh/kind: preflight
  name: "{{ .Release.Name }}-preflight-config"
stringData:
  preflight.yaml: |
    apiVersion: troubleshoot.sh/v1beta2
    kind: Preflight
    metadata:
      name: preflight-sample
    spec:
      collectors:[]
      analyzers:[]
```

Next, define the preflight checks specification by adding collectors and analyzers. Optionally, you can add to the default redactors. For more information, see [Define the Preflight Checks Specification](#preflights).

## Create a Preflight Custom Resource

The Preflight custom resource lets you provide preflight checks in a Helm template. If you use this input, you must use conditional statements in the custom resource because it is not installed in the cluster. Instead, the custom resource is read using stdin.

<PreflightsCrNote/>

To define a Preflight custom resource as a template:

1. Create a Preflight custom resource YAML file using `kind: Preflight`. Wrap the custom resource template in an `{{ if` so that it is only rendered when specified in the `values.yaml` file.

    **Example**:

    ```yaml
    {{ if .Values.renderpreflights }}
    apiVersion: troubleshoot.sh/v1beta2
    kind: Preflight
    metadata:
      name: example-name
    spec:
      collectors: []
      analyzers: []
    {{ end }}
    ```

1. Configure your `values.yaml` file with Helm templating to support the Preflight custom resource.

  **Example:**

  ```yaml
  renderpreflights: example-name
  ```

Next, define the preflight checks specification by adding collectors and analyzers. Optionally, you can add to the default redactors. For more information, see [Define the Preflight Checks Specification](#preflights).

## Define the Preflight Checks Specification {#preflights}

<PreflightsDefine/>

<PreflightsDefineXref/>

<PreflightSbHelmTemplates/>


### Collectors

Add collectors to define information to be collected for analysis during the analyze phase. For example, you can collect information about the MySQL version that is running in a cluster:

```yaml
spec:
      {{ if eq .Values.global.mariadb.enabled false }}
      collectors:
          - mysql:
            collectorName: mysql
            uri: '{{ .Values.global.externalDatabase.user }}:{{ .Values.global.externalDatabase.password }}@tcp({{ .Values.global.externalDatabase.host }}:{{ .Values.global.externalDatabase.port }})/{{ .Values.global.externalDatabase.database }}?tls=false'
      {{ end }}
```

<PreflightsDefineXref/>

Replicated recommends using a Helm template for the URI to avoid exposing sensitive information.

### Analyzers

<PreflightsAddAnalyzers/>

The following example shows an analyzer for the MySQL collector above:

```yaml
spec:
  collectors:
  - mysql:
      collectorName: mysql
      uri: '{{ .Values.global.externalDatabase.user }}:{{ .Values.global.externalDatabase.password }}@tcp({{ .Values.global.externalDatabase.host }}:{{ .Values.global.externalDatabase.port }})/{{ .Values.global.externalDatabase.database }}?tls=false'
  analyzers:
  - mysql:
      checkName: Must be MySQL 8.x or later
      collectorName: mysql
      outcomes:
      - fail:
          when: connected == false
          message: Cannot connect to MySQL server
      - fail:
          when: version < 8.x
          message: The MySQL server must be at least version 8
      - pass:
          message: The MySQL server is ready
```
<PreflightsDefineXref/>

<AnalyzersNote/>

### `strict` Analyzers

<PreflightsAddStrict/>

The following example shows the `strict` field set to `true` for MySQL versions:

```yaml
spec:
  collectors:
  - mysql:
      collectorName: mysql
      uri: '{{ .Values.global.externalDatabase.user }}:{{ .Values.global.externalDatabase.password }}@tcp({{ .Values.global.externalDatabase.host }}:{{ .Values.global.externalDatabase.port }})/{{ .Values.global.externalDatabase.database }}?tls=false'
  analyzers:
  - mysql:
      strict: true
      checkName: Must be MySQL 8.x or later
      collectorName: mysql
      outcomes:
      - fail:
          when: connected == false
          message: Cannot connect to MySQL server
      - fail:
          when: version < 8.x
          message: The MySQL server must be at least version 8
      - pass:
          message: The MySQL server is ready
```
<PreflightsDefineXref/>

## Redactors

<RedactorsAbout/>

## Example

The following example shows a preflight support bundle specification in a Secret for a Helm installation. For more examples, see the [Troubleshoot example repository](https://github.com/replicatedhq/troubleshoot/tree/main/examples/preflight) in GitHub.

<PreflightsDefineXref/>

```yaml
apiVersion: v1
kind: Secret
metadata:
  labels:
    troubleshoot.sh/kind: preflight
  name: "{{ .Release.Name }}-preflight-config"
stringData:
  # This is the preflight spec that will be used to run the preflight checks
  # Note: here we demonstrate using Helm's templating to conditionally run a preflight check based on a value
  # plus getting some configuration from the local values.yaml file
  preflight.yaml: |
    apiVersion: troubleshoot.sh/v1beta2
    kind: Preflight
    metadata:
      name: preflight-sample
    spec:
      {{ if eq .Values.global.mariadb.enabled false }}
      collectors:
          - mysql:
            collectorName: mysql
            uri: '{{ .Values.global.externalDatabase.user }}:{{ .Values.global.externalDatabase.password }}@tcp({{ .Values.global.externalDatabase.host }}:{{ .Values.global.externalDatabase.port }})/{{ .Values.global.externalDatabase.database }}?tls=false'
      {{ end }}
      analyzers:
        - nodeResources:
            checkName: Node Count Check
            outcomes:
              - fail:
                  when: 'count() > {{ .Values.global.maxNodeCount }}'
                  message: "The cluster has more than {{ .Values.global.maxNodeCount }} nodes."
              - pass:
                  message: You have the correct number of nodes.
        - clusterVersion:
            outcomes:
              - fail:
                  when: "< 1.22.0"
                  message: The application requires at least Kubernetes 1.22.0, and recommends 1.23.0.
                  uri: https://kubernetes.io
              - warn:
                  when: "< 1.23.0"
                  message: Your cluster meets the minimum version of Kubernetes, but we recommend you update to 1.18.0 or later.
                  uri: https://kubernetes.io
              - pass:
                  message: Your cluster meets the recommended and required versions of Kubernetes.
        {{ if eq .Values.global.mariadb.enabled false }}
        - mysql:
            checkName: Must be MySQL 8.x or later
            collectorName: mysql
            outcomes:
              - fail:
                  when: connected == false
                  message: Cannot connect to MySQL server
              - fail:
                  when: version < 8.x
                  message: The MySQL server must be at least version 8
              - pass:
                  message: The MySQL server is ready
        {{ end }}
```

## Next Step

Test your preflight checks in a development environment. For more information, see [Running Helm Preflight Checks](preflight-running).


