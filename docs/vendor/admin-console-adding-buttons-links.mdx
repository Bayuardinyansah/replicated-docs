import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import ServicePortNote from "../partials/custom-resource-application/_servicePort-note.mdx"
import PortsServiceName from "../partials/custom-resource-application/_ports-serviceName.mdx"
import PortsLocalPort from "../partials/custom-resource-application/_ports-localPort.mdx"
import PortsServicePort from "../partials/custom-resource-application/_ports-servicePort.mdx"
import PortsApplicationURL from "../partials/custom-resource-application/_ports-applicationURL.mdx"
import NginxKotsApp from "../partials/application-links/_nginx-kots-app.mdx"
import NginxK8sApp from "../partials/application-links/_nginx-k8s-app.mdx"
import NginxService from "../partials/application-links/_nginx-service.mdx"
import NginxDeployment from "../partials/application-links/_nginx-deployment.mdx"
import GiteaHelmChart from "../partials/getting-started/_gitea-helmchart-cr.mdx"
import GiteaKotsApp from "../partials/getting-started/_gitea-kots-app-cr.mdx"
import GiteaK8sApp from "../partials/getting-started/_gitea-k8s-app-cr.mdx"

# Adding Links to the Dashboard

This topic describes how to use the Kubernetes SIG Application custom resource to add links to the Replicated KOTS Admin Console dashboard.

## Overview

Replicated recommends that every application include a Kubernetes SIG Application custom resource. The Kubernetes SIG Application custom resource provides a standard API for creating, viewing, and managing applications. For more information, see [Kubernetes Applications](https://github.com/kubernetes-sigs/application#kubernetes-applications) in the kubernetes-sigs GitHub repository.

You can include the Kubernetes SIG Application custom resource in your releases to add links to the Admin Console dashboard. Common use cases include adding links to documentation, dashboards, or a landing page for the application.

For example, the following shows an **Open App** button on the dashboard of the Admin Console for an application named Gitea:

![Admin Console dashboard with Open App link](/images/gitea-open-app.png)

[View a larger version of this image](/images/gitea-open-app.png)

:::note
KOTS uses the Kubernetes SIG Application custom resource as metadata and does not require or use an in-cluster controller to handle this custom resource. An application that follows best practices does not require cluster admin privileges or any cluster-wide components to be installed.
:::

## Add a Link

To add a link to the Admin Console dashboard, include a [Kubernetes SIG Application](https://github.com/kubernetes-sigs/application#kubernetes-applications) custom resource in the release.

The SIG Application resource must include a `spec.descriptor.links` field, which is an array of links that will be displayed on the dashboard after the application is deployed. Each link in the `spec.descriptor.links` array contains two fields:
* `description`: The link text that will appear on the Admin Console dashboard.
* `url`: The target URL.

For example:

```yaml
# app.k8s.io/v1beta1 Application Custom resource

apiVersion: app.k8s.io/v1beta1
kind: Application
metadata:
  name: "gitea"
spec:
  descriptor:
    links:
      - description: About Wordpress
        url: "https://wordpress.org/"
```

When the application is deployed, the "About Wordpress" link is displayed on the Admin Console dashboard as shown below:

<img alt="About Wordpress link on the Admin Console dashboard" src="/images/dashboard-link-about-wordpress.png" width="450px"/>

[View a larger version of this image](/images/dashboard-link-about-wordpress.png)

For an example of a Kubernetes SIG Application custom resource, see [application.yaml](https://github.com/kubernetes-sigs/application/blob/master/docs/examples/wordpress/application.yaml) in the kubernetes-sigs GitHub repository.

### KOTS Template Functions in URLs

You can use KOTS template functions to template URLs in the Kubernetes SIG Application custom resource. This can be useful when all or some of the URL is a user-supplied value.

For example, an application might allow users to provide their own Ingress object. In this case, the URL can be templated to render the hostname for the Ingress object that the user supplies on the Admin Console config screen.

The following example shows how to use the KOTS [ConfigOption](/reference/template-functions-config-context#configoption) template function in the Kubernetes SIG Application custom resource `spec.descriptor.links.url` field to render a user-supplied hostname in the URL:

```yaml
apiVersion: app.k8s.io/v1beta1
kind: Application
metadata:
  name: "my-app"
spec:
  descriptor:
    links:
      - description: Open App
        url: 'http://{{repl ConfigOption "ingress_host" }}'
```

For more information about working with KOTS template functions, see [About Template Functions](/reference/template-functions-about).

## Link to Application Services Using KOTS

When distributing an application, it is helpful to ensure that the person or process installing the application is able to easily verify that the application is running. However, differences in customer environments make it difficult to provide a consistent application URL at installation.

To make it easier for users to access the deployed application, KOTS includes logic that can automatically rewrite the URL provided in the Kubernetes SIG Application custom resource:
* Update the hostname to use the same hostname where the Admin Console is accessed in the customer environments
* Add the specified service port

During application deployment, KOTS first checks if the `ports.applicationURL` field matches the `descriptor.links.url` field in the Kubernetes SIG Application custom resource. If the URLs match, then KOTS rewrites the URL to `http://localhost:{localPort}`, adding the local port provided for the service in the KOTS Application custom resource. Then, KOTS rewrites `localhost` to the hostname where the Admin Console is being accessed. For example, if the Admin Console is accessed at `gitea-admin.example.com:8800`, then the URL is rewritten to `http://gitea-admin.example.com:{localPort}`.

### Prerequisite

* For existing cluster installations, see [Port Forwarding Service with KOTS](/vendor/admin-console-port-forward).
* For kURL or Embedded Cluster, see [Exposing Services Using NodePorts](/vendor/kurl-nodeport-services).

### Link to a Service

Consider the following:
* Use `http` instead of `https` unless TLS termination takes place in the application Pod.
* You can use the service name in place of the hostname in the URL. KOTS rewrites the URL with the hostname in the browser.
* KOTS will only rewrite the URL when `ports.applicationURL` matches the `descriptor.links.url` field in the Kubernetes SIG Application custom resource. If the URLs in these fields do not match, then KOTS does not rewrite the URL.

:::note
The KOTS Application custom resource `ports` key is designed to port forward services in existing cluster installations. Although KOTS does not port forward services in kURL clusters or Embedded Clusters, the `ports` key must be configured in order to link to NodePort services using KOTS rewriting.
:::  

### Example: NGINX Application with ClusterIP and NodePort Services

The following example demonstrates how to expose a basic NGINX service for both existing cluster and embedded cluster installations.

To test this example:

1. Add the `example-service.yaml`, `example-deployment.yaml`, `kots-app.yaml`, and `k8s-app.yaml` files provided below to a new, empty release in the Vendor Portal. Promote to the channel that you use for internal testing.

    For more information, see [Managing Releases with the Vendor Portal](releases-creating-releases).

    <Tabs>
    <TabItem value="service" label="example-service.yaml" default>
    <h5>Description</h5>
    <p>The YAML below contains ClusterIP and NodePort specifications for a service named <code>nginx</code>. Each specification uses the <code>kots.io/when</code> annotation with the Replicated IsKurl template function to conditionally include the service based on the installation type (existing cluster or embedded kURL cluster). For more information, see <a href="/vendor/packaging-include-resources">Conditionally Including or Excluding Resources</a> and <a href="/reference/template-functions-static-context#iskurl">IsKurl</a>.</p>
    <p>As shown below, both the ClusterIP and NodePort <code>nginx</code> services are exposed on port 80.</p>
    <h5>YAML</h5>
    <NginxService/>
    </TabItem>
    <TabItem value="deployment" label="example-deployment.yaml" default>
    <h5>Description</h5>
    <p>A basic Deployment specification for the NGINX application.</p>
    <h5>YAML</h5>
    <NginxDeployment/>
    </TabItem>
    <TabItem value="kots-app" label="kots-app.yaml" default>
    <h5>Description</h5>
    <p>The KOTS Application custom resource below adds port 80 to the KOTS port forward tunnel and maps port 8888 on the local machine. The specification also includes <code>applicationUrl: "http://nginx"</code> so that a link to the service can be added to the Admin Console dashboard.</p>
    <h5>YAML</h5>
    <NginxKotsApp/>
    </TabItem>
    <TabItem value="k8s-app" label="k8s-app.yaml" default>
    <h5>Description</h5>
    <p>Using the value of <code>ports.applicationUrl</code> in <code>kots-app.yaml</code>, the Kubernetes Application custom resource below adds a link to the port-forwarded service from the Admin Console dashboard. The label to be used for the link in the Admin Console is "Open App".</p>
    <h5>YAML</h5>
    <NginxK8sApp/>
    </TabItem>
    </Tabs>

1. Install the release into an existing cluster and confirm that the service was port-forwarded successfully by clicking **Open App** on the Admin Console dashboard. For more information, see [Online Installation in Existing Clusters](/enterprise/installing-existing-cluster).

1. If there is not already a Kubernetes installer promoted to the channel, add a Kubernetes installer to the release to support kURL installs. For more information, see [Creating a Kubernetes Installer](/vendor/packaging-embedded-kubernetes).

1. Install the release on a VM and confirm that the service was exposed successfully by clicking **Open App** on the Admin Console dashboard. For more information, see [Online Installation with kURL](/enterprise/installing-kurl).

    :::note
    Ensure that the VM where you install allows HTTP traffic.
    :::

### Example: Bitnami Gitea Helm Chart with LoadBalancer Service

This example provides a KOTS Application custom resource and Kubernetes Application custom resource to configure port forwarding for the Bitnami Gitea Helm chart in existing cluster installations. To view the Gitea Helm chart source, see [bitnami/gitea](https://github.com/bitnami/charts/blob/main/bitnami/gitea) in GitHub.

To test this example:
1. Pull version 1.0.6 of the Gitea Helm chart from Bitnami:

    ```
    helm pull oci://registry-1.docker.io/bitnamicharts/gitea --version 1.0.6
    ```

1. Add the `gitea-1.0.6.tgz` chart archive to a new, empty release in the Vendor Portal along with the `kots-app.yaml`, `k8s-app.yaml`, and `gitea.yaml` files provided below. Promote to the channel that you use for internal testing.

    For more information, see [Managing Releases with the Vendor Portal](releases-creating-releases).

    <Tabs>
    <TabItem value="kots-app" label="kots-app.yaml" default>
    <h5>Description</h5>
    <p>Based on the <a href="https://github.com/bitnami/charts/blob/main/bitnami/gitea/templates/svc.yaml">templates/svc.yaml</a> and <a href="https://github.com/bitnami/charts/blob/main/bitnami/gitea/values.yaml">values.yaml</a> files in the Gitea Helm chart, the following KOTS Application custom resource adds port 3000 to the port forward tunnel and maps local port 8888. Port 3000 is the container port of the Pod where the <code>gitea</code> service runs.</p>
    <h5>YAML</h5>
    <GiteaKotsApp/>
    </TabItem>
    <TabItem value="k8s-app" label="k8s-app.yaml" default>
    <h5>Description</h5>
    <p>Using the value of <code>ports.applicationUrl</code> in <code>kots-app.yaml</code>, the Kubernetes Application custom resource below adds a link to the port-forwarded service from the Admin Console dashboard. The label to be used for the link in the Admin Console is "Open App".</p>
    <h5>YAML</h5>
    <GiteaK8sApp/>
    </TabItem>
    <TabItem value="helmchart" label="gitea.yaml" default>
    <h5>Description</h5>
    <p>The KOTS HelmChart custom resource provides instructions to KOTS about how to deploy the Helm chart. The <code>name</code> and <code>chartVersion</code> listed in the HelmChart custom resource must match the name and version of a Helm chart archive in the release. Each Helm chart archive in a release requires a unique HelmChart custom resource.</p>
    <h5>YAML</h5>
    <GiteaHelmChart/>
    </TabItem>
    </Tabs>

1. Install the release into an existing cluster and confirm that the service was port-forwarded successfully by clicking **Open App** on the Admin Console dashboard. For more information, see [Online Installation in Existing Clusters](/enterprise/installing-existing-cluster).

### Additional Resources and Examples

The following articles on the Replicated Community site provide additional information and examples related to configuring port forwarding:

* [Port forwarding for embedded cluster](https://community.replicated.com/t/port-forwarding-for-embedded-cluster/472)
* [Issues getting port forward / dashboard links working](https://community.replicated.com/t/issues-getting-port-forward-dashboard-links-working/809)