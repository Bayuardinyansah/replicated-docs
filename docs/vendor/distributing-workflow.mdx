import SDKOverview from "../partials/replicated-sdk/_overview.mdx"
import BestPractices from "../partials/getting-started/_best-practices.mdx"
import Community from "../partials/getting-started/_community.mdx"
import Prerequisites from "../partials/getting-started/_prerequisites.mdx"
import PackageSdk from "../partials/getting-started/_package-sdk.mdx"
import Preflights from "../partials/getting-started/_preflights.mdx"
import SupportBundles from "../partials/getting-started/_support-bundles.mdx"
import DependencyYaml from "../partials/replicated-sdk/_dependency-yaml.mdx"
import CiCd from "../partials/getting-started/_ci-cd.mdx"
import CustomMetrics from "../partials/getting-started/_custom-metrics.mdx"
import CustomChannels from "../partials/getting-started/_custom-channels.mdx"
import CustomDomains from "../partials/getting-started/_custom-domains.mdx"
import HelmPackage from "../partials/helm/_helm-package.mdx"
import UnauthorizedError from "../partials/replicated-sdk/_401-unauthorized.mdx"
import TestYourChanges from "../partials/getting-started/_test-your-changes.mdx"
import CreateRelease from "../partials/getting-started/_create-promote-release.mdx"
import EmbeddedConfig from "../partials/embedded-cluster/_default-config.mdx"
import Requirements from "../partials/embedded-cluster/_requirements.mdx"
import Cluster from "../partials/getting-started/_setup-cluster.mdx"
import ImageRegistry from "../partials/getting-started/_connect-image-registry.mdx"
import CustomizeSupportBundles from "../partials/getting-started/_customize-support-bundles.mdx"
import AboutPreflightsSupportBundles from "../partials/preflights/_overview.mdx"
import CustomEntitlements from "../partials/getting-started/_add-license-entitlements.mdx"
import CreateApp from "../partials/getting-started/_create-app.mdx"
import EnableProxyService from "../partials/getting-started/_enable-proxy-service.mdx"
import Intro from "../partials/getting-started/_onboard-intro.mdx"
import UpdateChecks from "../partials/getting-started/_sdk-api-update-checks.mdx"

# Embedded Cluster Onboarding 

This topic describes how to onboard applications that will support installation with Replicated KOTS, Replicated Embedded Cluster, and the Helm CLI.

If your application will support Helm CLI installations only, see [Helm CLI-Only Onboarding](/vendor/replicated-onboarding).

## Before You Begin

This section includes guidance and prerequisites to review before you begin onboarding your application.

### Prerequisites

<Prerequisites/>

* <Cluster/>

* Ensure that you have access to a VM that meets the requirements for Embedded Cluster:

  <Requirements/>

### Best Practices and Recommendations

<BestPractices/>

### Getting Help from the Community

<Community/>

## Onboard

<Intro/>

### Task 1: Create An Application

To get started with onboarding, first create a new application. This will be the official Vendor Portal application used by your team to create and promote both internal and customer-facing releases.

<CreateApp/>

### Task 2: Connect Your Image Registry

<ImageRegistry/>

### Task 3: Add the Replicated SDK and Package your Chart

Next, add the Replicated SDK as a dependency of your Helm chart then package the chart as a `.tgz` archive.

The Replicated SDK is a Helm chart that can be installed as a small service alongside your application. The SDK provides access to key Replicated functionality, including an in-cluster API and automatic access to insights and operational telemetry for instances running in customer environments. For more information, see [About the Replicated SDK](/vendor/replicated-sdk-overview).

To package your Helm chart with the Replicated SDK:

1. Go to the local directory where your Helm chart is.

1. <PackageSdk/>

   <DependencyYaml/>   

1. Update dependencies and package the chart as a `.tgz` file:

    <HelmPackage/>

    <UnauthorizedError/>

1. If your application is deployed as multiple Helm charts, package each chart as a separate `.tgz` archive using the `helm package -u PATH_TO_CHART` command. Do not declare the SDK in more than one chart.

### Task 4: Create and Install the Initial Release {#first-release}

After packaging your Helm chart, you can create a release. The initial release for your application will include the minimum files required to install a Helm chart with Embedded Cluster:
* The Helm chart `.tgz` archive
* [KOTS HelmChart custom resource](/reference/custom-resource-helmchart-v2)
* [Embedded Cluster Config](/reference/embedded-config)

If you have multiple charts, you will add each chart archive to the release, plus a corresponding KOTS HelmChart custom resource for each archive.

To create the first release for your application:

1. In the local directory for your Helm chart, create a subdirectory named `manifests` where you will add the files for the release.

1. In the `manifests` directory:

   1. Move the `.tgz` chart archive that you packaged. If your application is deployed as multiple Helm charts, move each `.tgz` archive to `manifests`.

   1. Create an `embedded-cluster.yaml` file with the following default Embedded Cluster Config:

      <EmbeddedConfig/>
    
      For more information, see [Using Embedded Cluster](/vendor/embedded-overview).

   1. Create a new YAML file. In this file, configure the KOTS HelmChart custom resource by completing the workflow in [Configuring the HelmChart Custom Resource](helm-native-v2-using).
   
      The KOTS HelmChart custom resource is required to install Helm charts with KOTS and Embedded Cluster. As part of configuring the KOTS HelmChart custom resource, you will rewrite image names and add image pull secrets to enable the Replicated proxy service.

   1. If your application is deployed as multiple Helm charts, repeat the step above to add a separate HelmChart custom resource for each Helm chart archive in the release.

1. From the `manifests` directory, create a release and promote it to the Unstable channel. For more information, see [Managing Releases with the Vendor Portal](releases-creating-releases) or [Managing Releases with the CLI](releases-creating-cli).

    ```bash
    replicated release create --yaml-dir . --promote Unstable
    ```

1. Install the release in your development environment to test:

   1. Install with Embedded Cluster on a VM. See [Download the Embedded Cluster Binary](/vendor/embedded-overview#download-the-embedded-cluster-binary) and [Install](/vendor/embedded-overview#install) in _Using Embedded Cluster_.

   1. Install in an existing cluster with KOTS. See [Online Installation in Existing Clusters](/enterprise/installing-existing-cluster).

After successfully installing the initial release both on a VM and in an existing cluster, go to the next task. You will continue to iterate throughout the rest of the onboarding process by creating and promoting new releases, then upgrading to the new version in your development environment.

### Task 5: Customize the KOTS Admin Console {#admin-console}

Configure the KOTS Application custom resource to add an application name, icon, and status informers. The name and icon will be displayed in the Admin Console and the Replicated Download Portal. The status informers will be used to display the application status on the Admin Console dashboard.

To configure the KOTS Application custom resource:

1. In your `manifests` directory, create a new `kots-app.yaml` file.

1. In the `kots-app.yaml` file, add the [KOTS Application](/reference/custom-resource-application) custom resource YAML and set the `title`, `icon`, and `statusInformers` fields.

   **Example:**

    ```yaml
    apiVersion: kots.io/v1beta1
    kind: Application
    metadata:
      name: gitea
    spec:
      title: Gitea
      icon: https://raw.githubusercontent.com/cncf/artwork/master/projects/kubernetes/icon/color/kubernetes-icon-color.png
      statusInformers:
        - deployment/gitea
    ```
    For more information, see:
    * [Customizing the Application Icon](/vendor/admin-console-customize-app-icon)
    * [Enabling and Understanding Application Status](/vendor/insights-app-status)
    * [Application](/reference/custom-resource-application)

1. <CreateRelease/>

1. <TestYourChanges/>

### Task 6: Set Up the Admin Console Config Screen and Map to Helm Values

The KOTS Admin Console config screen is used to collect required and optional application configuration values from your users. User-supplied values provided on the config screen can be mapped to your Helm values.

:::note
Before you begin this task, you can complete the [Set Helm Values with KOTS](/vendor/tutorial-config-setup) tutorial to learn how to map user-supplied values from the Admin Console config screen to a Helm chart.
:::

To set up the Admin Console Config screen for your application:

1. In your `manifests` directory, create a new file named `kots-config.yaml`.

1. In `kots-config.yaml`, add the KOTS Config custom resource. Configure the KOTS Config custom resource based on the values that you need to collect from users.

    **Example:**

    ```yaml
    apiVersion: kots.io/v1beta1
    kind: Config
    metadata:
      name: my-application
    spec:
      groups:
        - name: example_group
          title: Example Group
          items:
            - name: example_item
              title: Example Item
              type: text
              default: "Hello World"
    ```

    For more information, see:
    * [Creating and Editing Configuration Fields](/vendor/admin-console-customize-config-screen) 
    * [Using Conditional Statements in Configuration Fields](/vendor/config-screen-conditional)  
    * [Config](/reference/custom-resource-config)  

1. <CreateRelease/>

1. <TestYourChanges/>

1. In `manifests`, open the KOTS HelmChart custom resource that you configured in a previous step. Configure the `values` key of the HelmChart custom resource to map the fields in the KOTS Config custom resource to your Helm values.

   For more information, see:
   * [Mapping User-Supplied Values](/vendor/config-screen-map-inputs)
   * [Tutorial: Set Helm Chart Values with KOTS](/vendor/tutorial-config-setup)
   * [`values`](/reference/custom-resource-helmchart-v2#values) in _HelmChart v2_

1. <CreateRelease/>

1. <TestYourChanges/>

1. Continue to create and test new releases with new config fields until you are ready to move on to the next task.

### Task 7: Define Preflight Checks

In the next two tasks, you will add specs for _preflight checks_ and _support bundles_.

<AboutPreflightsSupportBundles/>

<Preflights/>

### Task 8: Add a Support Bundle Spec

<SupportBundles/>

### Task 9: Alias Replicated Endpoints with Custom Domains

<CustomDomains/>

## Next Steps

After completing the main onboarding tasks, Replicated recommends that you also complete the following additional tasks to integrate other Replicated features with your application. You can complete these next recommended tasks in any order.

### Add Support for Helm Installations

Existing KOTS releases that include one or more Helm charts can be installed with the Helm CLI; it is not necessary to create and manage separate releases or channels for each installation method. To enable Helm installations for Helm charts distributed with Replicated, the only extra step is to add a Secret to your chart to authenticate with the Replicated proxy service.  

:::note
Before you test Helm installations for your application, you can complete the [Deploy a Helm Chart with KOTS and the Helm CLI](tutorial-kots-helm-setup) tutorial to learn how to install a single release with both KOTS and Helm.
:::

To support and test Helm installations:

<EnableProxyService/>

### Add Support for Air Gap Installations

KOTS and Embedded Cluster support installations in _air gap_ environments with no outbound internet access. Users can install in air gap environments by providing air gap bundles that contain the required images.

You can use the Vendor Portal to build and download the air gap bundles needed to install in an air gap existing cluster with KOTS or in an air gap VM or bare metal server with Embedded Cluster.

To add support for air gap installations:

1. If there are any images that need to be included in the `.airgap` bundle that are _not_ defined in your application Pod specs, list these images in the `additionalImages` attribute of the KOTS Application custom resource. This ensures that the images are included in the `.airgap` bundle for the release. See [Define Additional Images](/vendor/operator-defining-additional-images).

1. In the KOTS HelmChart custom resource, configure the `builder` key. The Vendor Portal uses the values provided in the `builder` key to build the `.airgap` bundle for the release. See [Packaging Air Gap Bundles for Helm Charts](/vendor/helm-packaging-airgap-bundles).

    :::note
    If the default values in your Helm chart already enable all the images needed to successfully deploy the chart, then you do not need to configure the `builder` key.
    :::

1. If you have not done so already as part of [Task 4: Create and Install the Initial Release](#first-release), ensure that the `values` key in the KOTS HelmChart custom resource correctly rewrites image names for air gap installations. See [Rewrite Image Names](/vendor/helm-native-v2-using#rewrite-image-names) in _Configuring the HelmChart Custom Resource v2_.

1. Create a customer with the **Airgap Download Enabled** entitlement enabled so that you can test air gap installations. See [Creating and Managing Customers](/vendor/releases-creating-customer).

1. Download the Embedded Cluster release artifacts for air gap installations, then install with Embedded Cluster on an air gap VM to test. See [Installing in Air Gap Environments with Embedded Cluster](/enterprise/installing-embedded-air-gap).

1. Download the `.airgap` bundle for the release and the air gap bundle for the KOTS Admin Console. You can download both bundles from the Download Portal for the target customer. See [Building Air Gap Bundles](/vendor/releases-download-airgap-bundles). Then, install in an air gap existing cluster to test. See [Air Gap Installation in Existing Clusters](/enterprise/installing-existing-cluster-airgapped).

### Add Application Links to the Admin Console Dashboard

You can add the Kubernetes SIG Application custom resource in order to add a link to your application from the Admin Console dashboard. This makes it easier for users to access your application after installation.

For more information, see [Adding Application Links to the Dashboard](/vendor/admin-console-adding-buttons-links).

### Update the Preflight and Support Bundles Specs

<CustomizeSupportBundles/>

### Add and Query Custom License Entitlements

<CustomEntitlements/>

For more information, see:
* [Managing Custom License Fields](/vendor/licenses-adding-custom-fields)
* [Querying Entitlements with the Replicated SDK API](/vendor/licenses-reference-sdk)
* [Checking Entitlements in Preflights with KOTS Template Functions](/vendor/licenses-referencing-fields)
* [Verifying License Field Signatures with the Replicated SDK API](/vendor/licenses-verify-fields-sdk-api)
* [Creating and Managing Customers](/vendor/releases-creating-customer)
* [Developing Against the SDK API](/vendor/replicated-sdk-development)

### Configure Backup and Restore

Enable backup and restore with Velero for your application so that users can back up and restore their KOTS Admin Console and application data. 

There are different steps to configure backup and restore for Embedded Cluster and for existing cluster installations with KOTS:
* To configure the disaster recovery feature for Embedded Cluster, see [Disaster Recovery for Embedded Cluster](/vendor/embedded-disaster-recovery)
* To configure the snapshots feature for existing cluster KOTS installations, see [Configuring Backup and Restore](snapshots-configuring-backups).

### Add Custom Metrics

<CustomMetrics/>

### Integrate with CI/CD

<CiCd/>

### Customize Release Channels

<CustomChannels/>

### Add Update Checks to Your Application Using the Replicated SDK API

<UpdateChecks/>