import PreflightsAddAnalyzers from "../partials/preflights/_preflights-add-analyzers.mdx"
import PreflightsAddStrict from "../partials/preflights/_preflights-add-strict.mdx"
import PreflightsHelmGuidance from "../partials/preflights/_preflights-helm-guidance.mdx"


# Define Helm Preflight Checks

You define preflight checks based on your application needs. Replicated recommends that you use prelight checks to help ensure that your customers' environments support your application _before_ running the installation. 

Preflight checks are not included by default, so you must enable them. This procedure provides a basic understanding and some key considerations to help guide you in enabling them for your application.

Preflight checks run before running the `helm install` command, without hooks, to confirm the target cluster has the resources required for a successful install.

When you supply the output of `helm template` to the preflight command as stdin, the command filters the stream and searches for and runs the following specifications:

-  Secrets or ConfigMaps containing preflight specifications
-  Custom resources of `kind: preflight`

<PreflightsHelmGuidance/> 

You can create a resource that can be read from stdin and still take advantage of Helm templates.

Resource options include:

- Storing a Secret in the cluster.
- Providing a URL or a YAML file, without templating from `values.yaml`, such as a `preflight https://my-preflight.url.com`, or `preflight preflight.yaml`.
- Using a Helm template to create a Preflight custom resource, but the custom resource is not installed in the cluster. For more information about Preflight custom resource, see [Preflight and Support Bundle](/reference/custom-resource-preflight).

  The template can be wrapped in an `{{ if` so that it is only rendered when specified, such as: `helm template mychart --set renderpreflights=true --values values.yaml | preflight -`

    **Example**:

    ```yaml
    {{ if .Values.renderpreflights }}
    apiVersion: troubleshoot.sh/v1beta2
    kind: Preflight
    metadata:
    name: example
    spec:
    collectors:
    etc etc
    {{ end }}
    ```

## Define Preflight Checks as Secrets

The preflight checks you run are dependent on your application needs. This procedure gives some guidance about how to think about using collectors and analyzers, as you design your preflight checks. For more information about defining preflight checks, see [Collecting Data](https://troubleshoot.sh/docs/collect/)
and [Analyzing Data](https://troubleshoot.sh/docs/analyze/) in the Troubleshoot documentation.

Additionally, this procedure uses a Secret with `pre-install` and `pre-upgrade` hook and weight annotations. You can omit these annotations if you want the checks to run during installation instead or if you want to run the preflight checks before using the `helm template` command to trigger the checks before installation. 

<PreflightsHelmGuidance/>

To define preflight checks as a Secret:

1. Create a Secret specification (`kind: Secret`). Alternatively, you can use a ConfigMap (`kind: configMap`) if the specification will not collect private information from the cluster.

  You must include the following:

    - `Label` - Label the secret definition as `troubleshoot.sh/kind: preflight`
    - `stringData` - Specify a `stringData` field with a key named `preflight.yaml` so that the preflight binary can use this Secret when it runs from the CLI.

    ```yaml
    apiVersion: v1
    kind: Secret
    metadata:
    name: preflight-secret
    labels:
        troubleshoot.sh/kind: preflight
    stringData:
      preflight.yaml: |-
        apiVersion: troubleshoot.sh/v1beta2
        kind: Preflight
        metadata:
        name: preflights
        spec: â€¦
    ```
1. Add collectors to define information to be collected for analysis during the analyze phase. For example, you can collect information about the MySQL version that is running in a cluster:

    ```yaml
    apiVersion: v1
    kind: Secret
    metadata:
    name: preflight-secret
    labels:
        troubleshoot.sh/kind: preflight
    annotations:
        "helm.sh/hook": pre-install, pre-upgrade
        "helm.sh/hook-weight": "-6"
        "helm.sh/hook-delete-policy": before-hook-creation, hook-succeeded, hook-failed
    stringData:
    preflight.yaml: |-
        apiVersion: troubleshoot.sh/v1beta2
        kind: Preflight
        metadata:
        name: preflights
        spec:
            collectors:
            - mysql:
                collectorName: mysql
                uri: 'repl{{ ConfigOption "db_user" }}:repl{{ConfigOption "db_password" }}@tcp(repl{{ ConfigOption "db_host" }}:repl{{ConfigOption "db_port" }})/repl{{ ConfigOption "db_name" }}'
    ```
    Replicated recommends replacing using a template function for the URI to avoid exposing sensitive information. For more information about template functions, see [About Template Functions](/reference/template-functions-about).

1. <PreflightsAddAnalyzers/>

1. <PreflightsAddStrict/>

    The following example shows a strict analyzer for MySQL versions:

    ```yaml
    apiVersion: v1
    kind: Secret
    metadata:
    name: preflight-secret
    labels:
        troubleshoot.sh/kind: preflight
    annotations:
        "helm.sh/hook": pre-install, pre-upgrade
        "helm.sh/hook-weight": "-6"
        "helm.sh/hook-delete-policy": before-hook-creation, hook-succeeded, hook-failed
    stringData:
    preflight.yaml: |-
        apiVersion: troubleshoot.sh/v1beta2
        kind: Preflight
        metadata:
        name: preflights
        spec:
            collectors:
            - mysql:
                collectorName: mysql
                uri: 'repl{{ ConfigOption "db_user" }}:repl{{ConfigOption "db_password" }}@tcp(repl{{ ConfigOption "db_host" }}:repl{{ConfigOption "db_port" }})/repl{{ ConfigOption "db_name" }}'
            analyzers:
            - mysql:
                strict: true
                checkName: Must be MySQL 8.x or later
                collectorName: mysql
                outcomes:
                - fail:
                    when: connected == false
                    message: Cannot connect to MySQL server
                - fail:
                    when: version < 8.x
                    message: The MySQL server must be at least version 8
                - pass:
                    message: The MySQL server is ready
    ```
1. Test your preflight checks in a development environment. For more information, see [Running Helm Preflight Checks](preflight-running).

