= Snapshots

:page-slug: /docs/vendor/snapshots/
:page-order: 0
:page-section: Vendor


= Snapshots overview

KOTS Snapshots is the backup and restore feature for applications deployed with KOTS. This is an optional feature, and it requires that licenses have the Allow Snapshots feature enabled.

To enable Snapshots, KOTS uses the https://velero.io/[Velero open source project] on the backend to back up Kubernetes manifests and persistent volumes. Velero is a mature, fully-featured application.

In addition to the default functionality that Velero provides, KOTS provides a detailed interface in the [admin console](/kotsadm/snapshots/overview) where end users can manage the storage destination and schedule, and perform and monitor the backup process. These details can also be managed using the KOTS CLI.

NOTE: The restore process is managed through the KOTS CLI only.

KOTS also exposes hooks that can be used to inject scripts to execute with Snapshots both [before and after a backup](/vendor/snapshots/configuring-backup) and [before and after a restore](/kotsadm/snapshots/restore).

== Velero version compatibility

[cols="1,1"]
|===
| KOTS Version(s) | Velero Version

| 1.15 to 1.20.2
| 1.2.0

| 1.20.3+
| 1.5.1
|===

= Configuring backups

The KOTS Snapshots feature is a backup and restore option that lets you define a manifest for executing snapshots and restoring previous snapshots.

. To enable snapshots:

.. Add a backup resource to the application using the Velero manifest. The following minimal YAML example enables Snapshots in the application. When a snapshot is executed in the admin console or by a schedule, Snapshots will include all annotated volumes in the archive (see the additional information on annotating volumes later in this task).
+
**Example**
+
[source,YAML]
----

apiVersion: velero.io/v1
kind: Backup
metadata:
  name: backup
spec: {}

----

.. Optional: Configure the [optional resources](/vendor/packaging/include-resources/) annotation in the manifest so that it can be dynamically enabled based on a license field or a config option.
+
NOTE: If you are using multiple applications, each application should have a [backup resource](/reference/v1beta1/backup/) in each application's manifest so that each application can be included in the [Full Snapshot](/kotsadm/snapshots/overview/#full-snapshots-recommended) backup.

. Configure a backup for any volumes that require backup. By default, no volumes are included in the backup. If any pods mount a volume that should be backed up, you must configure the backup with an annotation listing the specific volumes to include in the snapshot.
+
The annotation name is `backup.velero.io/backup-volumes` and the value is a comma separated list of volumes to include in the backup.
+
For example, in the following deployment, `pvc-volume` is the only volume that is backed up. The `scratch` volume is not included in the backup because it is not listed in annotation on the pod spec.
+
[source,YAML]
----

apiVersion: apps/v1
kind: Deployment
metadata:
  name: sample
  labels:
    app: foo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: foo
  template:
    metadata:
      labels:
        app: foo
      annotations:
        backup.velero.io/backup-volumes: pvc-volume
    spec:
      containers:
      - image: k8s.gcr.io/test-webserver
        name: test-webserver
        volumeMounts:
        - name: pvc-volume
          mountPath: /volume-1
        - name: scratch
          mountPath: /volume-2
      volumes:
      - name: pvc-volume
        persistentVolumeClaim:
          claimName: test-volume-claim
      - name: scratch
        emptyDir: {}

----

. Optional: Configure manifest exclusions. By default, Velero also includes snapshots of all of the Kubernetes objects in the namespace. To exclude any manifest, add a `velero.io/exclude-from-backup` label to the manifest to be excluded.
+
**Example**
+
[source,YAML]

----
apiVersion: apps/v1
kind: Secret
metadata:
  name: sample
  labels:
    velero.io/exclude-from-backup: "true"
stringData:
  uri: Secret To Not Include

----

= Backup hooks

For many application workloads, additional processing or scripts need to be run before and/or after a backup is taken to prepare the system for a backup.
Velero has support for this, using https://velero.io/docs/main/backup-hooks/[Backup Hooks].

Some common examples of how a Hook can be used to create successful backups are:

* Run `pg_dump` to export a postgres database prior to backup
* Lock a file before running a backup, and unlock immediately after
* Delete TMP files that should not be backed up

Backup hooks should be run inside the container that contains the data to back up.

A common pattern of applications is to include and want to back up a postgres database.
Postgres is easy to include from a Helm chart, and the following HelmChart kind can be used to configure Postgres for backups. An explanation of the configuration follows the YAML.

.Example
[source,YAML]
----
apiVersion: kots.io/v1beta1
kind: HelmChart
metadata:
  name: postgresql
spec:
  exclude: 'repl{{ ConfigOptionEquals `postgres_type` `external_postgres` }}'

  chart:
    name: postgresql
    chartVersion: 8.7.4

  values:

    master:
      podAnnotations:
        backup.velero.io/backup-volumes: backup
        pre.hook.backup.velero.io/command: '["/bin/bash", "-c", "PGPASSWORD=$POSTGRES_PASSWORD pg_dump -U username -d dbname -h 127.0.0.1 > /scratch/backup.sql"]'
        pre.hook.backup.velero.io/timeout: 3m

      extraVolumes:
        - name: backup
          emptyDir:
            medium: Memory
            sizeLimit: 1Gi
      extraVolumeMounts:
        - name: backup
          mountPath: /scratch

    global:
      postgresql:
        postgresqlUsername: username
        postgresqlPassword: "repl{{ ConfigOption `embedded_postgres_password` }}"
        postgresqlDatabase: dbname

  builder: {}

----

In this example, a few fields are worth explaining:

spec.exclude:: This is a common and recommended pattern for KOTS applications. The customer can choose (using the config screen) to bring an external postgres instance instead of running it in-cluster.
When this is set, we want to exclude the chart from installing.

spec.values.master.podannotations:: Here we add a few annotations to the postgres master podspec (not the statefulset, this will add the annotations to the podspec).
+
The annotations are:
+
[cols"1,1"]
|===
| Annotation | Description

| `backup.velero.io/backup-volumes`
| A comma separated list of volumes from the pod to include in the backup. The primary data volume is not included here.

| `pre.hook.backup.velero.io/command`
| A stringified JSON array containing the pre backup hook command.
This command is a `pg_dump` from the running database to the backup volume

| `pre.hook.backup.velero.io/timeout`
| A duration for the maximum time to let this script run.
|===

spec.master.extraVolumes:: This is a new volume that we inject into the postgres pod. It's an empty volume, stored in memory (does not require a PVC or storage).
We mount this into the `/scratch` directory of the master pod, and use it as a destination when running `pg_dump` above (in the hooks).
This is the only volume that we will back up.

== Additional resources
* xref:pages/docs/vendor/snapshots/snapshots-overview/[Snapshots overview]
* [Including and excluding resources](https://kots.io/vendor/packaging/include-resources/)
* [About backup resources](https://kots.io/reference/v1beta1/backup/)
