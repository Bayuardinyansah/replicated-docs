import VersionLimitation from "../partials/helm/_helm-version-limitation.mdx"
import HelmBuilderRequirements from "../partials/helm/_helm-builder-requirements.mdx"
import Chart from "../partials/helm/_helm-cr-chart.mdx"
import ChartName from "../partials/helm/_helm-cr-chart-name.mdx"
import ChartVersion from "../partials/helm/_helm-cr-chart-version.mdx"
import ChartReleaseName from "../partials/helm/_helm-cr-chart-release-name.mdx"
import HelmUpgradeFlags from "../partials/helm/_helm-cr-upgrade-flags.mdx"
import Values from "../partials/helm/_helm-cr-values.mdx"
import Weight from "../partials/helm/_helm-cr-weight.mdx"
import Exclude from "../partials/helm/_helm-cr-exclude.mdx"
import OptionalValues from "../partials/helm/_helm-cr-optional-values.mdx"
import OptionalValuesWhen from "../partials/helm/_helm-cr-optional-values-when.mdx"
import OptionalValuesRecursiveMerge from "../partials/helm/_helm-cr-optional-values-recursive-merge.mdx"
import Namespace from "../partials/helm/_helm-cr-namespace.mdx"
import Intro from "../partials/helm/_helm-cr-intro.mdx"
import BuilderAirgapIntro from "../partials/helm/_helm-cr-builder-airgap-intro.mdx"
import BuilderExample from "../partials/helm/_helm-cr-builder-example.mdx"

# HelmChart v2 (Beta)

> Introduced in Replicated app manager v1.99.0

The HelmChart v2 custom resource supports the native Helm v2 installation. This v2 installation method does a Helm install or upgrade of your Helm chart without modifying it with Kustomize. This is an improvement to the v1 installation method because it results in Helm installations that can be reproduced outside of the app manager, and it enables the use of additional Helm functionality that was not available in v1. Because this method bypasses existing Kustomize logic to rewrite images, inject pull secrets, and add backup labels, you must configure a combination of Replicated and Helm templating for the images, pull secrets, and backup labels.

<Intro/>

## Example

The following is an example manifest file for the HelmChart v2 custom resource:

```yaml
apiVersion: kots.io/v1beta2
kind: HelmChart
metadata:
  name: samplechart
spec:
  # chart identifies a matching chart from a .tgz
  chart:
    name: samplechart
    chartVersion: 3.1.7
  
  releaseName: samplechart-release-1

  exclude: "repl{{ ConfigOptionEquals `include_chart` `include_chart_no`}}"

  # weight determines the order that charts are applied, with lower weights first.
  weight: 42

  # helmUpgradeFlags specifies additional flags to pass to the `helm upgrade` command.
  helmUpgradeFlags:
    - --skip-crds
    - --no-hooks
    - --timeout
    - 1200s
    - --history-max=15

  # values are used in the customer environment, as a pre-render step
  # these values will be supplied to helm template
  values:
    postgresql:
      enabled: repl{{ ConfigOptionEquals `postgres_type` `embedded_postgres`}}

  optionalValues:
    - when: "repl{{ ConfigOptionEquals `postgres_type` `external_postgres`}}"
      recursiveMerge: false
      values:
        postgresql:
          postgresqlDatabase: "repl{{ if ConfigOptionEquals `postgres_type` `external_postgres`}}repl{{ ConfigOption `external_postgres_database`}}repl{{ end}}"
          postgresqlUsername: "repl{{ if ConfigOptionEquals `postgres_type` `external_postgres`}}repl{{ ConfigOption `external_postgres_username`}}repl{{ end}}"
          postgresqlHost: "repl{{ if ConfigOptionEquals `postgres_type` `external_postgres`}}repl{{ ConfigOption `external_postgres_host`}}repl{{ end}}"
          postgresqlPassword: "repl{{ if ConfigOptionEquals `postgres_type` `external_postgres`}}repl{{ ConfigOption `external_postgres_password`}}repl{{ end}}"
          postgresqlPort: "repl{{ if ConfigOptionEquals `postgres_type` `external_postgres`}}repl{{ ConfigOption `external_postgres_port`}}repl{{ end}}"

  # namespace allows for a chart to be installed in an alternate namespace to
  # the default
  namespace: samplechart-namespace

  # builder values provide a way to render the chart with all images
  # and manifests. this is used in Replicated to create `.airgap` packages
  builder:
    postgresql:
      enabled: true
```

## chart

<Chart/>

### chart.name

<ChartName/>

### chart.chartVersion

<ChartVersion/>

## releaseName

<ChartReleaseName/>

## weight

<Weight/>

## helmUpgradeFlags

<HelmUpgradeFlags/>

## values

<Values/>

## exclude

<Exclude/>

## optionalValues

<OptionalValues/>

### optionalValues[].when

<OptionalValuesWhen/>

### optionalValues[].recursiveMerge

<OptionalValuesRecursiveMerge/>

## namespace

<Namespace/>

## builder

The `builder` field is required for the following use cases:

* <BuilderAirgapIntro/>

* To support online installations that are configured to push and pull from a private registry. In this case, your customer must not enable the `--disable-image-push` flag for the `kots install` command or disable pushing the images to a registry in the admin console. By default, pushing images to a registry is enabled.

  You must provide the necessary values in the `builder` field to render the Helm chart with all of the necessary images so that the app manager knows where to pull the images from to push them into the private registry.

  If you already support an air gap installation, use the same `builder` field configuration for this online installation use case. No additional changes are needed.

<HelmBuilderRequirements/>

**Example:**

<BuilderExample/>
