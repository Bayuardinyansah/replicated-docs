import Prerequisites from "../partials/helm/_helm-install-prereqs.mdx"

# Installing and Updating with Helm in an Air Gap Environment (Alpha)

:::note
Air gap Helm installations are an Alpha feature. If you are interested in trying Helm air gap installations and providing feedback, please reach out to your account rep to enable this feature.
:::

## Overview

Replicated supports installing and updating Helm charts in air gap environments with no outbound internet access. In air gap Helm installations, customers are guided through the process with instructions provided in the [Replicated Download Portal](/vendor/releases-share-download-portal).

When air gap Helm installations are enabled, an **Existing cluster with Helm** option is displayed in the Download Portal on the left nav. When selected, **Existing cluster with Helm** displays three tabs (**Install**, **Manual Update**, **Automate Updates**), as shown in the screenshot below:

![download helm option](/images/download-helm.png)

[View a larger version of this image](/images/download-helm.png)

Each tab provides instructions for how to install, perform a manual update, or configure automatic updates, respectively.

These installing and updating instructions assume that your customer is accessing the Download Portal from a workstation that can access the internet and their internal private registry. Direct access to the target cluster is not required.

Each method assumes that your customer is familiar with `curl`, `docker`, `helm`, `kubernetes`, and a bit of `bash`, particularly for automating updates.

## Prerequisites

Before you install, complete the following prerequisites:

* Reach out to your account rep to enable the Helm air gap installation feature.

<Prerequisites/>

## Install

The installation instructions provided in the Download Portal are designed to walk your customer through the first installation of your chart in an air gap environment.

To install with Helm in an air gap environment:

1. In the [Vendor Portal](https://vendor.replicated.com), go to **Customers > [Customer Name] > Reporting**.

1. In the **Download portal** section, click **Visit download portal** to log in to the Download Portal for the customer.

1. In the Download Portal left nav, click **Existing cluster with Helm**. 

     ![download helm option](/images/download-helm.png)

     [View a larger version of this image](/images/download-helm.png)

1. In the **App version** dropdown, select the target application version to install.

1. On the **Install** tab, run the first command to authenticate into the Replicated proxy registry with the customer's credentials (the `license_id`).

1. Under **Get the list of images**, for each image in the list, run the corresponding `docker` `pull`, `tag`, and `push` commands provided.

    :::note
    If customers provided their own registry URI, Replicatd pre-configures these commands. Otherwise, customers need to manually replace the image names in the `tag` and `push` commands.
    :::

1. Run the next command to authenticate into the OCI registry that contains your Helm chart, and then install the `preflight` plugin. 

1. Get the default `values.yaml` and edit it as required. Customers will edit the Helm values to meet their environment's configuration needs. 

    :::note
    Replicated recommends that vendors provide detailed documentation that describes the values that customers need to configure. 
    :::

1. Finally, specify how to access the cluster and then use the corresponding commands and edited `values.yaml` to run preflight checks and install the chart.

## Perform Updates

This section describes the processes of performing manual and automatic updates with Helm in air gap environments using the instructions provided in the Download Portal.

### Manual Updates

The manual update instructions provided in the Download Portal are similar to the installation instructions.

However, the first step prompts the customer to select their current version an the target version to install.

This step takes [required releases](/vendor/releases-about#properties) into consideration, thereby guiding the customer to the versions that are upgradable from their current version. 

The additional steps are consistent with installation process until the `preflight` and `install` commands where customers provide the existing values from the cluster with the `helm get values` and `--reuse-values` commands.

Should you introduce new images, or other values, you should call this out at the top of your release notes so that customers know they will need to make additional edits to the `values.yaml` before installing. 

### Automate Updates

The automate update instructions rely on a few new API endpoints that your customers can automate against. 

The instructions in the Download Portal provide customers with example commands that can be put into a script that they run periodically (as in, nightly or weekly) using GitHub Actions, Jenkins etc.

This method assumes that the customer has already done a successful manual installation, including the configuration of the appropriate `values`.

After logging into the registry, the customer exports their current version and uses that to query an endpoint that provides the latest installable version number (either the next required release, or the latest release) and export it as the target version. With the target version, they can now query an API for the list of images. 

With the list of images the provided `bash` script will automate the process of pulling updated images from the repository, tagging them with a name for an internal registry, and then pushing the newly tagged images to their internal registry. 

With the assumption that the customer has set up the `values` to preserve the updated tag, they should now be able to login to the OCI registry and perform the commands to install the updated chart.